<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>JavaScript Engines Hidden Classes (and Why You Should Keep Them in Mind) | concise notes</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name="description" content="An introduction.">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaScript Engines Hidden Classes (and Why You Should Keep Them in Mind)">
<meta property="og:url" content="https://vhf.github.io/blog/2016/09/10/javascript-engines-hidden-classes/index.html">
<meta property="og:site_name" content="concise notes">
<meta property="og:description" content="An introduction.">
<meta property="og:image" content="https://vhf.github.io/blog/hiddenclasses-step0.svg">
<meta property="og:image" content="https://vhf.github.io/blog/hiddenclasses-step1.svg">
<meta property="og:image" content="https://vhf.github.io/blog/hiddenclasses-step2.svg">
<meta property="og:image" content="https://vhf.github.io/blog/hiddenclasses-snapshot.png">
<meta property="og:image" content="https://vhf.github.io/blog/hiddenclasses-snapshot-hover.png">
<meta property="og:updated_time" content="2016-09-11T13:33:03.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JavaScript Engines Hidden Classes (and Why You Should Keep Them in Mind)">
<meta name="twitter:description" content="An introduction.">
<meta name="twitter:image" content="https://vhf.github.io/blog/hiddenclasses-step0.svg">
<meta name="twitter:creator" content="@_vhf">
<link rel="alternate" href="/blog/atom.xml" title="concise notes" type="application/atom+xml">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<link rel="icon" sizes="16x16 32x32 64x64" href="/favicons/favicon.ico">
<link rel="icon" type="image/png" sizes="196x196" href="/favicons/favicon-192.png">
<link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96.png">
<link rel="icon" type="image/png" sizes="64x64" href="/favicons/favicon-64.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16.png">
<link rel="apple-touch-icon" href="/favicons/favicon-57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicons/favicon-114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicons/favicon-72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicons/favicon-144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicons/favicon-60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicons/favicon-120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicons/favicon-76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicons/favicon-152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/favicon-180.png">
<meta name="msapplication-TileColor" content="#FFFFFF">
<meta name="msapplication-TileImage" content="/favicons/favicon-144.png">
<meta name="msapplication-config" content="/favicons/browserconfig.xml">
<link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="/blog/css/style.css">
<script type="text/javascript">!function(e,a,n,t,c,i,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,i=a.createElement(n),o=a.getElementsByTagName(n)[0],i.async=1,i.src=t,o.parentNode.insertBefore(i,o)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-69443473-1","auto"),ga("require","linkid"),ga("send","pageview")</script>
</head>
<body>
<div class="container">
<div class="page-wrap">
<header class="page-header" role="banner" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
<nav itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
<div class="nav-wrapper">
<h1 class="brand-logo" itemprop="headline"><a href="/blog/" rel="home">concise notes</a></h1>
<meta itemprop="description" content="Victor Felder's blog">
<a href="#" id="mobile-menu" class="hide-on-med-and-up menu-icon"></a>
<nav role="navigation" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
<ul class="right hide-on-small-only">
<li><a class="main-nav-link" href="/blog/">Home</a></li>
<li><a class="main-nav-link" href="/blog/archives">Archives</a></li>
<li><a class="main-nav-link" href="/blog/contact">Contact</a></li>
<li><a class="main-nav-link" href="https://vhf.github.io">About</a></li>
<li><a class="rss-icon" href="/blog/atom.xml" title="RSS Feed"></a></li>
</ul>
</nav>
</div>
</nav>
</header>
<div class="pattern"></div>
<main class="page-main" role="main" tabindex="-1">
<article id="post-javascript-engines-hidden-classes" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
<link itemprop="mainEntityOfPage" href="/blog/2016/09/10/javascript-engines-hidden-classes/">
<nav class="hide-on-small-only">
<div class="nav-wrapper">
<div class="col s12">
<a href="/blog/2016/09/10/javascript-engines-hidden-classes/" class="breadcrumb">
<time datetime="2016-09-10T16:40:48.000Z" itemprop="datePublished">2016-09-10</time>
<time class="hide" datetime="2016-09-10T16:40:48.000Z" itemprop="dateModified">2016-09-10</time>
</a>
<a class="breadcrumb breadcrumb-link" href="/blog/categories/programming/">programming</a><a class="breadcrumb breadcrumb-link" href="/blog/categories/programming/JavaScript/">JavaScript</a>
<span class="hide" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<span itemprop="name">
<a class="breadcrumb" href="https://plus.google.com/102455247906663845886" itemprop="url" rel="author">victor felder</a>
</span>
</span>
<div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
<meta itemprop="name" content="concise notes">
</div>
</div>
</div>
</nav>
<div class="article-inner">
<header class="article-header">
<h1 class="article-title" itemprop="headline">
JavaScript Engines Hidden Classes (and Why You Should Keep Them in Mind)
</h1>
</header>
<div class="article-entry" itemprop="articleBody">
<p>When V8 lead engineer Lars Bak<sup id="a1"><a href="#f1" title="Jump to footnote">1</a></sup> <a href="https://www.youtube.com/watch?v=hWhMKalEicY" target="_blank" rel="external">describes</a> V8 design decisions, the first thing he talks about are hidden classes.</p>
<p>To better understand hidden classes we need to know what problem they solve. This article is a first introduction to this concept. It will:</p>
<ol>
<li>cover fast property access because it’s something hidden classes make possible,</li>
<li>explain what hidden classes are and where they come from,</li>
<li>tell you how you can observe them in their natural habitat because Chromium provides us with an awesome microscope,</li>
<li>say a few things about inline caching because here as well using hidden classes can lead to big performance boost,</li>
<li>show you why keeping them in mind can improve your JavaScript performance eg. by avoiding property deletion or polymorphic call-sites.</li>
</ol>
<h3 id="Properties-in-an-OO-World"><a href="#Properties-in-an-OO-World" class="headerlink" title="Properties in an OO World"></a>Properties in an OO World</h3><p>In a class-based object-oriented language such as Smalltalk or Java in which you cannot add or delete properties from an object on the fly, accessing properties is generally not costly. You can store object properties at fixed memory offsets because the object layout for an instance of a given class will never change. In this case, accessing a property can often be done with a single instruction: load the thing located at the given memory offset.</p>
<p>In an imaginary Java virtual machine, a Java object could be stored in memory as a simple structure which is the exact same for all instances of a same class. The properties (attributes, methods, …) are either primitive Java types (int, float, …) or pointers (to arrays, functions, …). This structure doesn’t hold the “whole” object data, it merely holds references (memory offsets) to where the “real” data is stored. Or as another JVM could do, an object could be stored as three simple pointers: the first one to the class object representing the type of the object, the second one to a table holding pointers to the object’s methods, the third one to the memory allocated for the object data.</p>
<p>At this point, you noticed I’m mainly talking about strategies to store an object in memory and access their properties. We call this <strong>property access</strong> which means retrieving the value of an object property. It’s a mechanism we use all the time, here is how we leverage it in JavaScript:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> o = &#123; <span class="comment">// object</span></div><div class="line">  f: <span class="function">(<span class="params">x</span>) =&gt;</span> <span class="built_in">parseInt</span>(x, <span class="number">13</span>),</div><div class="line">  <span class="number">1337</span>: <span class="number">13.37</span> + <span class="number">20</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">o.f <span class="comment">// property access =&gt; function f</span></div><div class="line">o[<span class="number">1337</span>] <span class="comment">// property access =&gt; 33.37</span></div><div class="line">o.f(o[<span class="number">1337</span>]) <span class="comment">// performs two property accesses and one function call =&gt; 42</span></div></pre></td></tr></table></figure>
<p>As you may know, JavaScript is prototype-based (and class-free, not class-based).</p>
<blockquote>
<p>Objects are mutable in JavaScript, so we can augment the new instances, giving them new fields and methods. These can then act as prototypes for even newer objects. We don’t need classes to make lots of similar objects.</p>
<p class="quote-author"><a href="http://javascript.crockford.com/prototypal.html" target="_blank" rel="external">Douglas Crockford</a></p>
</blockquote>
<p>Not only are objects created by “cloning” existing prototypes, they can also be created by using the <em>literal</em> notation (or <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer" target="_blank" rel="external"><em>initializer</em> notation</a>) which you then can just as easily modify on the fly.</p>
<p>An important part of running some JavaScript code is creating objects, putting them in memory and retrieving them or only retrieving some of their properties. We will focus here on <a href="https://tc39.github.io/ecma262/#sec-ordinary-object" target="_blank" rel="external">ordinary JavaScript objects</a> (as opposed to <a href="https://tc39.github.io/ecma262/#sec-exotic-object" target="_blank" rel="external">exotic objects</a>) and discuss property access techniques.</p>
<h3 id="The-Property-Access-Problem-Dynamic-Lookups-are-Slow"><a href="#The-Property-Access-Problem-Dynamic-Lookups-are-Slow" class="headerlink" title="The Property Access Problem: Dynamic Lookups are Slow"></a>The Property Access Problem: Dynamic Lookups are Slow</h3><p>Let’s get back to the topic: how can we implement property access? Looking at what the ECMAScript 2015 specification proposes is a good starting point.</p>
<p>Under section <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-ordinary-and-exotic-objects-behaviours" target="_blank" rel="external">9 Ordinary and Exotic Objects Behaviours</a>, <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-ordinary-object-internal-methods-and-internal-slots-get-p-receiver" target="_blank" rel="external">9.1.8 [[Get]]</a> describes the following algorithm (simplified for the purpose of this article):</p>
<p>When we do <code>obj[prop]</code> or <code>obj.prop</code>, …</p>
<ol>
<li>Make sure <code>typeof prop</code> is either <code>&#39;string&#39;</code> or <code>&#39;symbol&#39;</code>. (<code>obj[13]</code> does in fact <code>obj[&#39;13&#39;]</code>.)</li>
<li>If <code>prop</code> is a direct property of <code>obj</code> and <code>obj[prop]</code> is not <code>undefined</code>, return <code>obj[prop]</code>. End.</li>
<li>If <code>prop</code> is not a direct property of <code>obj</code> or if <code>obj[prop]</code> is <code>undefined</code>, then<br>a. Let <em>parent</em> be <code>obj</code>‘s prototype<br>b. Do the same as <code>2.</code> using <em>parent</em> instead of <code>obj</code>.<br>c. If <em>parent</em> is <code>null</code>, return <code>undefined</code>. End.<br>d. Go down the prototype chain: go back to <code>1.</code> but with <em>parent</em> instead of <code>obj</code> (which means it’ll retry the same procedure with <code>parent[prop]</code>).</li>
</ol>
<p>This is called <em>dynamic lookup</em>. This lookup is <em>dynamic</em> because at runtime we try to find <code>prop</code> on <code>obj</code>, if we fail we try the same on its prototype, then on the prototype’s prototype, etc.</p>
<p>We could implement a (big) dictionary (or associative array) where you would store all the objects used by the program. Keys would be references to objects and the values would in turn be dictionaries with their properties as key and values:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Your JavaScript code:</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x, y</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.x = x;</div><div class="line">  <span class="keyword">this</span>.y = y;</div><div class="line">&#125;</div><div class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> Point(<span class="number">12</span>, <span class="number">3</span>);</div><div class="line"><span class="keyword">const</span> p2 = <span class="keyword">new</span> Point(<span class="number">5</span>, <span class="number">9</span>);</div><div class="line"><span class="keyword">const</span> p3 = <span class="keyword">new</span> Point(<span class="number">12</span>);</div><div class="line"><span class="keyword">const</span> lit = &#123; <span class="attr">name</span>: <span class="string">'Bond'</span> &#125;;</div><div class="line"></div><div class="line"><span class="comment">// The JavaScript engine's dictionary storing the objects</span></div><div class="line"><span class="keyword">const</span> allObjects = &#123;</div><div class="line">  <span class="attr">o0</span>: &#123; <span class="comment">// p1</span></div><div class="line">    __proto__: <span class="string">'p6a1251'</span>, <span class="comment">// Object&#123;constructor: Point(x, y), __proto__: Object&#123;constructor: Object()&#125;&#125;</span></div><div class="line">    x: <span class="number">12</span>,</div><div class="line">    <span class="attr">y</span>: <span class="number">3</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">o1</span>: &#123; <span class="comment">// p2</span></div><div class="line">    __proto__: <span class="string">'p6a1251'</span>, <span class="comment">// Object&#123;constructor: Point(x, y), __proto__: Object&#123;constructor: Object()&#125;&#125;</span></div><div class="line">    x: <span class="number">5</span>,</div><div class="line">    <span class="attr">y</span>: <span class="number">9</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">o2</span>: &#123; <span class="comment">// p3</span></div><div class="line">    __proto__: <span class="string">'p6a1251'</span>, <span class="comment">// Object&#123;constructor: Point(x, y), __proto__: Object&#123;constructor: Object()&#125;&#125;</span></div><div class="line">    x: <span class="number">12</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">o3</span>: &#123; <span class="comment">// lit</span></div><div class="line">    __proto__: <span class="string">'p419ecc'</span>, <span class="comment">// Object&#123;constructor: Object()&#125;</span></div><div class="line">    name: <span class="string">'Bond'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>V8 is not implemented in JavaScript, but this should give you a basic idea of how we could store all the objects used in a JavaScript program using a dictionary. (This dictionary would probably be implemented as a hash table.)</p>
<p>Now let’s say we want to get <code>p1.z</code>, <code>p1</code> being the first object created in our program hence having <code>o0</code> as reference. Let’s roughly follow the algorithm we took from the ECMAScript spec:</p>
<ol>
<li>Find <code>o0</code> in <code>allObjects</code> (<em>lookup</em> to resolve the object’s location in memory),</li>
<li>Find a property named <code>&quot;x&quot;</code> in <code>o0</code> (<em>dynamic lookup</em> to resolve the property’s location in memory) and return its value. (Should we have tried <code>p1.x</code>, we could have stopped here, returning <code>12</code>.)</li>
<li>Since <code>o0</code> does not have a property named <code>&quot;x&quot;</code>, fetch <code>o0.__proto__</code> to see if it has a property named <code>&quot;x&quot;</code>, otherwise look if <code>o0.__proto__.__proto__</code> has a property named <code>&quot;x&quot;</code>, repeat this process down the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Inheritance_and_the_prototype_chain" target="_blank" rel="external">prototype chain</a> until <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/Proto" target="_blank" rel="external"><code>__proto__</code></a> is <code>null</code> (which means no object prototype was found).</li>
</ol>
<p>As you can probably guess, this process is not efficient.</p>
<h3 id="The-Property-Access-Solution-Hidden-classes"><a href="#The-Property-Access-Solution-Hidden-classes" class="headerlink" title="The Property Access Solution: Hidden classes"></a>The Property Access Solution: Hidden classes</h3><p>Instead of resorting to dynamic lookup to access properties, V8 implements <em>hidden classes</em>, a concept originally present in another prototype-based programming language: SELF. Here is a quote from the abstract of the 1989 paper which first described this idea: (emphasis is mine)</p>
<blockquote>
<p>[…] SELF implementation runs twice as fast as the fastest Smalltalk implementation, <strong>despite SELF’s lack of classes</strong> and explicit variables.</p>
<p><strong>To compensate for the absence of classes, our system uses implementation-level <em>maps</em> to transparently group objects cloned from the same prototype</strong> […]</p>
<p class="quote-author"><a href="http://dl.acm.org/citation.cfm?doid=74878.74884" target="_blank" rel="external">C. Chambers, D. Ungar, and E. Lee. “An Efficient Implementation Of SELF, a Dynamically-Typed Object-Oriented Language Based on Prototypes.” <em>SIGPLAN Not. 24</em>, no. 10 (September 1989): 49–70.</a></p>
</blockquote>
<p><em>Hidden class</em> is a better, more explicit name for what this paper calls a <em>map</em>. It makes reference to SELF and avoids confusion with the <em>Map</em> data structures and their JavaScript implementation <em><a href="ecmamap">Map Objects</a></em>, although in fact they really are named <em>maps</em> in V8. This short vocabulary brief will prove handy when we’ll start digging into V8. I’ll mostly stick to the <em>hidden classes</em> terminology but don’t be surprised if I drop a <em>map</em> here and there for variety.</p>
<p>Most of the modern JavaScript engines we use today implement similar approaches or hidden classes variants. Safari <a href="https://en.wikipedia.org/wiki/WebKit#JavaScriptCore" target="_blank" rel="external">JavaScriptCore</a> has <em>structures</em>. Microsoft Edge’s ChakraCore has <em><a href="http://abchatra.github.io/Type/" target="_blank" rel="external">type</a>s</em>. Firefox’ SpiderMonkey has <em>shapes</em>:</p>
<blockquote>
<p>There are a number of data structures within SpiderMonkey dedicated to making object property accesses fast. The most important of these are Shapes. […] Shapes are linked into linear sequences called “shape lineages”, which describe object layouts. Some shape lineages are shared and live in “property trees”. Other shape lineages are unshared and belong to a single JS object; these are “in dictionary mode”.</p>
<p class="quote-author"><a href="https://blog.mozilla.org/nnethercote/2011/11/01/spidermonkey-is-on-a-diet/" target="_blank" rel="external">Nicholas Nethercote</a> (<a href="http://www.masonchang.com/blog/2008/5/28/spidermonkeys-secret-object-sauce.html" target="_blank" rel="external">more</a>)</p>
</blockquote>
<p>Everyone seems to use variants of these hidden classes but what do they look like, how are they generated? Let’s take a look at what V8 does. Here is our Point function again:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x, y</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.x = x;</div><div class="line">  <span class="keyword">this</span>.y = y;</div><div class="line">&#125;</div><div class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> Point(<span class="number">13</span>, <span class="number">37</span>);</div><div class="line"><span class="keyword">const</span> p2 = <span class="keyword">new</span> Point(<span class="number">2</span>);</div><div class="line"><span class="keyword">const</span> p3 = <span class="keyword">new</span> Point();</div><div class="line"><span class="keyword">const</span> p4 = <span class="keyword">new</span> Point(<span class="number">4</span>, <span class="number">2</span>);</div></pre></td></tr></table></figure>
<p>From what we read about hidden classes (or maps) we could expect our engine to create a map for <code>Point</code> as soon as it assigns <code>p1</code> and reuse this same map for <code>p2</code>, <code>p3</code> and <code>p4</code>. Not quite. We are in fact looking at 3 related but different maps here. (Although this part is well illustrated in <a href="https://developers.google.com/v8/design" target="_blank" rel="external">V8 design reference</a>, their documentation hasn’t been updated for almost 4 years and it’s worth paraphrasing.)</p>
<p>Let’s start with the first part of our code. We define a function <code>Point</code> which we’ll use as constructor for many points. It has two parameters, <code>x</code> and <code>y</code>, and its objects will remember the arguments we pass to this Point constructor.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x, y</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.x = x;</div><div class="line">  <span class="keyword">this</span>.y = y;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>At this point in time V8 puts our function in memory but we don’t really care about this, our point is what happens when <em>create</em> a point:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> Point(<span class="number">13</span>, <span class="number">37</span>);</div></pre></td></tr></table></figure>
<p>When V8 sees our first usage of the <code>Point</code> function (or constructor) to create a new object based on this <code>Point</code> prototype it doesn’t yet know what a Point really looks like, all it knows is <code>function Point</code> so it creates an initial version <code>C0</code> of the hidden class <code>p1</code> needs.</p>
<p><img src="hiddenclasses-step0.svg" alt=""></p>
<p>This first hidden class <code>C0</code> represents a <code>Point</code> object without any property (<code>{}</code>). At the same time, V8 allocates our <code>p1</code> variable as some memory object containing nothing but a <em>class pointer</em> to store the fact that <code>p1</code>‘s hidden class will be <code>C0</code> for now.</p>
<p>Entering the <code>Point</code> function with our arguments <code>13</code> and <code>37</code>, the next thing V8 encounters is <code>this.x = x;</code>, which resolves to <code>this.x = 13;</code>. Aha! The point <code>p1</code> (which is <code>this</code> here) has a property called <code>x</code> and this property is not part of the map <code>C0</code>! First thing first, <code>13</code> is put in memory at this object’s first memory offset (the spots where all the data contained in an object is stored) - we’ll call it <code>offset 0</code>. V8 then creates a new hidden class <code>C1</code> based on <code>C0</code>. What <code>C1</code> brings to the table is a reference to a property named <code>x</code>, for which the data is stored at the object’s <code>offset 0</code>.</p>
<p>V8 modifies <code>C0</code> to tell it that each time an object with the hidden class <code>C0</code> gets a property named <code>x</code> added to it, this object will have to <em>transition</em> to using <code>C1</code> instead as its hidden class.</p>
<p><img src="hiddenclasses-step1.svg" alt=""></p>
<p>Next line is <code>this.y = y;</code>, ie. <code>this.y = 37</code>. Here is what happens internally: First <code>37</code> is stored at the next memory offset, <code>offset 1</code>. Then a new hidden class <code>C2</code> is created by cloning <code>C1</code> (I say <em>cloning</em> because <code>C2</code> is the same as <code>C1</code> at this point: it has a reference to a property named <code>x</code> for which the data is at <code>offset 0</code>). <code>C2</code> receives the additional ability to have a property named <code>y</code>, for which the data can be found at its object’s <code>offset 1</code>.</p>
<p>Now that we have a more capable hidden class than <code>C1</code>, <code>C1</code>‘s <em>transition plan</em> is updated to tell all <code>C1</code> objects that they can transition to using <code>C2</code> should they get a property named <code>y</code> set to them.</p>
<p><img src="hiddenclasses-step2.svg" alt=""></p>
<p>This might all seem a bit schematic and by now you are probably wondering if you could observe this behaviour all by yourself. Fortunately, Chrome developer tools allows us to do just that. Kudos to their team for exposing hidden classes to the end users. Someone at Mozilla told me they considered adding this capability to their own developer tools but nobody implemented it… yet.</p>
<p>If you want to play along, open a tab in Google Chrome or Chromium, fire up the devtools, open the devtools settings (focus the devtools and hit <code>F1</code>) and enable <em>Show advanced heap snapshot properties</em> in the <em>Profiler</em> section of the <em>Preferences</em> tab.</p>
<p>Close the settings, go to the console, copy the following code and evaluate it:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x, y</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.x = x;</div><div class="line">  <span class="keyword">this</span>.y = y;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> p0 = <span class="keyword">new</span> Point();       <span class="comment">// C0</span></div><div class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> Point(<span class="number">13</span>);     <span class="comment">// C1 ← C0</span></div><div class="line"><span class="keyword">const</span> p2 = <span class="keyword">new</span> Point(<span class="number">13</span>, <span class="number">37</span>); <span class="comment">// C2 ← C1 ← C0</span></div></pre></td></tr></table></figure>
<p>Switch to the <em>Profiles</em> tab, select <em>Take Heap Snapshot</em> and hit the <em>Take Snapshot</em> button. Once this done, a couple MB of data have been collected and we can use the <em>Class filter</em> box to filter our objects. Just type <em>Point</em>, the name of our function. You should be able to see the three points we just created. I uncollapsed a few object properties, here’s what I see:</p>
<p><img src="hiddenclasses-snapshot.png" alt=""></p>
<p>A few basics to get us started:</p>
<ul>
<li><code>Point @81129</code>: an object with id <code>81129</code>, its prototype is <code>Point</code>. This is <code>p0</code> by the way. Next one is <code>p1</code>, then <code>p2</code>.<ul>
<li><code>__proto__ :: @79373</code> the id of this object’s prototype is <code>79373</code>. See how all our three points have this same prototype with the same id <code>@79373</code>?</li>
</ul>
</li>
</ul>
<p>Note that you can “preview” some objects by hovering their id (eg. <code>@123</code>):</p>
<p><img src="hiddenclasses-snapshot-hover.png" alt=""></p>
<p>Remember when I said that internally V8 hidden classes were named <em>maps</em>? Yep, that’s what we’re looking at, how exciting!</p>
<ul>
<li><code>Point @81129</code><ul>
<li><code>map :: system / Map @79399</code> The hidden class for <code>p0</code>, our <code>C0</code>! Now uncollapse map:<ul>
<li><code>back_pointer :: system / Map @79395</code><ul>
<li><code>back_pointer :: system / Map @79375</code><ul>
<li><code>transition :: system @79435</code><ul>
<li><code>2 :: system / Map @79457</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>Point @81133</code><ul>
<li><code>map :: system / Map @79453</code> The hidden class for <code>p1</code>, ie. <code>C1</code>.</li>
</ul>
</li>
<li><code>Point @81137</code><ul>
<li><code>map :: system / Map @79457</code> The hidden class for <code>p2</code>, ie. <code>C2</code>.</li>
</ul>
</li>
</ul>
<p>&lt;- Talk about V8 devtools Maps with examples, then say a few words about #jsapi saved buffer wrt. linked lists and hashmaps -&gt;</p>
<h3 id="deleting-properties"><a href="#deleting-properties" class="headerlink" title="deleting properties"></a>deleting properties</h3><p>–&gt; STRONG MODE</p>
<hr>
<p>READ THIS: <a href="http://jayconrod.com/posts/52/a-tour-of-v8-object-representation" target="_blank" rel="external">http://jayconrod.com/posts/52/a-tour-of-v8-object-representation</a><br>READ THIS: <a href="http://floitsch.blogspot.ch/2012/03/optimizing-for-v8-inlining.html" target="_blank" rel="external">http://floitsch.blogspot.ch/2012/03/optimizing-for-v8-inlining.html</a><br>READ THIS: <a href="http://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html" target="_blank" rel="external">http://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html</a></p>
<p><b id="f1">1</b> Lars Bak spent the last 30 years implementing and optimizing virtual machines. He worked on the SELF, Strongtalk, HotSpo, V8 and now Dart VMs. The best parts of V8 come from his previous experience. From SELF (which is similar to JavaScript in that they’re both prototype-based OO languages) came inline caching, inlining and deoptimization. What was learned from Strongtalk became a big part of HotSpot’s success. Which then heavily influenced V8 (JIT), and then Dart came inspired by Smalltalk, JavaScript, C# and Erlang while its VM only kept the best parts of SELF, Strongtalk and HotSpot. Notice the name <em>HotSpot</em>? It comes from its ability to profile bytecode at runtime and target “hot spots” (frequently executed parts of code, eg. hot functions or hot code) for optimization, just like <a href="http://vhf.github.io/blog/2016/01/22/chromium-chrome-v8-crankshaft-bailout-reasons/#Crankshaft_and_bailouts">V8 does</a>. <a href="#a1" title="Jump back to footnote reference">↩</a></p>
</div>
<footer class="article-footer">
<div class="row">
<div class="col s6">
<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/crankshaft/">crankshaft</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/v8/">v8</a></li></ul>
&nbsp;
</div>
<div class="col s6 right-align">
<div class="article-footer-right">
<a data-url="https://vhf.github.io/blog/2016/09/10/javascript-engines-hidden-classes/" data-id="cisynrgza00019zabekinja2w" class="article-share-link">
<span class="text">share</span>
</a>
or
<a href="https://github.com/vhf/concise-notes/edit/master/source/_posts/2016-02-25-javascript-engines-hidden-classes.md" class="article-suggest-modification">
<span class="text">suggest a modification</span>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="row post-navigation">
<div class="col s12">
<div class="post-nav">
<div class="post-nav-title blue-grey darken-1 left center-align">
<span class="white-text">Older</span>
</div>
<div class="post-nav-content post-nav-next clear">
<a href="/blog/2016/05/16/ngw-2016/">
!!Con and a week back at the Recurse Center
</a>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="page-footer blue-grey darken-3">
<div class="row">
<div class="col l3 m6 s12">
<h5 class="white-text">Categories</h5>
<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/programming/">programming</a><span class="category-list-count">12</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/programming/JavaScript/">JavaScript</a><span class="category-list-count">9</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/project/">project</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/project/old-tech-new-ideas/">old tech new ideas</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/project/tools/">tools</a><span class="category-list-count">1</span></li></ul></li></ul>
</div>
<div class="col l3 m6 s12">
<h5 class="white-text">Tags</h5>
<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/babel/">babel</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/chrome/">chrome</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/crankshaft/">crankshaft</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/es2015/">es2015</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/file-systems/">file systems</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/github/">github</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/hiring/">hiring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ipython/">ipython</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/javascript/">javascript</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/nodejs/">nodejs</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/osx/">osx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/programming-language-design/">programming language design</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/promises/">promises</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/rss/">rss</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/scala/">scala</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/spark/">spark</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/v8/">v8</a><span class="tag-list-count">6</span></li></ul>
</div>
<div class="col l3 m6 s12">
<h5 class="white-text">Archives</h5>
<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/05/">May 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/02/">February 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/01/">January 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/11/">November 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li></ul>
</div>
<div class="col l3 m6 s12">
<h5 class="white-text">Recent posts</h5>
<ul>
<li>
<a href="/blog/2016/09/10/javascript-engines-hidden-classes/">JavaScript Engines Hidden Classes (and Why You Should Keep Them in Mind)</a>
</li>
<li>
<a href="/blog/2016/05/16/ngw-2016/">!!Con and a week back at the Recurse Center</a>
</li>
<li>
<a href="/blog/2016/03/21/rss-usage-on-the-web/">How Many Websites Provide RSS / Web Syndication Feeds</a>
</li>
<li>
<a href="/blog/2016/02/06/navigating-the-ecmascript-2015-language-specification/">Navigating the ECMAScript® 2015 Language Specification</a>
</li>
<li>
<a href="/blog/2016/02/04/the-dangers-of-hfs-for-git-repositories/">The dangers of HFS+ for git repositories</a>
</li>
</ul>
</div>
</div>
<div class="footer-copyright blue-grey darken-3">
unless otherwise stated, all content &amp; design &copy; copyright 2016 victor felder &mdash; <span class="post-count">26.0k words total</span><br>
</div>
</footer>
</div>
<nav class="side-nav">
<ul id="nav-mobile">
<li><a class="main-nav-link" href="/blog/">Home</a></li>
<li><a class="main-nav-link" href="/blog/archives">Archives</a></li>
<li><a class="main-nav-link" href="/blog/contact">Contact</a></li>
<li><a class="main-nav-link" href="https://vhf.github.io">About</a></li>
<li><a id="mobile-menu-close" class="main-nav-link" href="#">Close the menu</a></li>
</ul>
</nav>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="/blog/js/script.js"></script>
</body>
</html>