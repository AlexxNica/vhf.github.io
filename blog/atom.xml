<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>concise notes</title>
  
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://vhf.github.io/blog/"/>
  <updated>2016-05-16T17:45:53.000Z</updated>
  <id>https://vhf.github.io/blog/</id>
  
  <author>
    <name>victor felder</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>!!Con and a week back at the Recurse Center</title>
    <link href="https://vhf.github.io/blog/2016/05/16/ngw-2016/"/>
    <id>https://vhf.github.io/blog/2016/05/16/ngw-2016/</id>
    <published>2016-05-16T15:36:41.000Z</published>
    <updated>2016-05-16T17:45:53.000Z</updated>
    
    <content type="html">&lt;p&gt;10 days ago I attended &lt;a href=&quot;http://bangbangcon.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;!!Con&lt;/a&gt;, the most excellent &lt;del&gt;dumpling house&lt;/del&gt; programming conference. I was blown away by the quality of the talks, the skills/knowledge/humor of the presenters, the diversity and kindness of both the organizers and the crowd, and the two incredible keynotes &lt;a href=&quot;http://cattsmall.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Catt Small&lt;/a&gt; and &lt;a href=&quot;http://nas.sr&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Ramsey Nasser&lt;/a&gt; gave. The whole conference was also captioned in realtime by &lt;a href=&quot;http://stenoknight.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Mirabai Knight&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Here are some &lt;a href=&quot;https://github.com/bangbangcon/bangbangcon.github.io/tree/master/2016-speaker-materials&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;slides&lt;/a&gt;, the &lt;a href=&quot;https://twitter.com/bangbangcon/status/730418049824608256&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;full video recordings&lt;/a&gt; of the live stream and the whole &lt;a href=&quot;http://aloft.nu/mkk/bangbangconsaturday&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;trans&lt;/a&gt;c&lt;a href=&quot;http://aloft.nu/mkk/bangbangconsunday&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ripts&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Besides (having breakfast and) meeting great people there, a few highlights include the following talks, in alphabetical order:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Sina Bahram presenting how he uses his phone and computer by listening to his screenreader at 1,000 words per minute. Multimodal interface: using pitch to differentiate uppercase from lowercase!&lt;/li&gt;
&lt;li&gt;Sher Minn Chong generating fractal plants with L-Systems&lt;/li&gt;
&lt;li&gt;Jake Levine talking about alphabetical ordering in Japanese:&lt;ul&gt;
&lt;li&gt;it turns out Japanese words are usually ordered by how the first syllables sound&lt;/li&gt;
&lt;li&gt;which is really tricky for kanjis, because they can be pronounced differently depending on the context in which the word is used&lt;/li&gt;
&lt;li&gt;therefore only Japanese speaking humans can properly sort Japanese words!&lt;/li&gt;
&lt;li&gt;Apologies to the contributors of &lt;a href=&quot;https://github.com/vhf/free-programming-books/blob/master/free-programming-books-ja.md&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;free-programming-books-ja&lt;/a&gt; to whom I might have asked to comply with my automatic JavaScript alphabetical ordering checker. :/&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Kamal Marhubi OOMing his computer after &lt;a href=&quot;https://twitter.com/lablayers/status/729022540358782976&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;holding a pipe in the air using his hands as file descriptors&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Allison Parrish generating poetry out of the first paragraph of the genesis by applying DST to Word2Vec, here is what I remember from her presentation:&lt;ul&gt;
&lt;li&gt;take word2vec, train it&lt;/li&gt;
&lt;li&gt;take an input text, get the vectors for its words&lt;/li&gt;
&lt;li&gt;“simplify” or rather lossily compress each of these vectors using a discrete cosine transform&lt;/li&gt;
&lt;li&gt;reconstruct the input text word after word by finding for each compressed vector the closest existing word vector&lt;/li&gt;
&lt;li&gt;The idea is simply amazing in my opinion, I loved it. So much artistic/fun potential in this!&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Mark Phillips showcasing his &lt;a href=&quot;http://watersheds.fernleafinteractive.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;amazing hydrological interactive map of the US&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I then spent the week at the &lt;a href=&quot;http://recurse.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;recurse center&lt;/a&gt; with around 100 smart passionate people, a few I already knew and was so glad to meet again and many I had never met.&lt;/p&gt;
&lt;p&gt;I could probably spend a week writing about what I learned while talking with people there (or reviewing all the awesome food and drinks I had with Carlos). Instead, I’ll mention a few highlights of my week:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;In Chrome, the backspace key of my MacBook wouldn’t take me to the previous page anymore, so I went to closest person I could find using a Mac and asked him if the same thing was happening to him or if he knew what could be going on. Turns out this person, Sidney, is about to start working on Chrome for OS X at Google! Some digging later, &lt;a href=&quot;https://codereview.chromium.org/1922993002/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;here’s why&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;I met David who is building a fascinating HTTP proxy back/front-end in Elixir and was extremely motivated to help me fix my Elixir request thrower. We spent quite some time working on it together, and while facing some weird networking performance issues we turned to Julia who we knew is always keen to dive into weird things. She got interested in Elixir and Erlang, and we learned about stracing all the things!&lt;/li&gt;
&lt;li&gt;A few people expressed interest in my recent V8 elucubrations so I threw together a 30’ presentation. Almost 15 people showed up and I finally got to train explaining some of the material I spent weeks gathering!&lt;/li&gt;
&lt;li&gt;I got a lot from a chat with Dan about jobs and career opportunities.&lt;/li&gt;
&lt;li&gt;Jonathan proposed to pair on an IPFS/JavaScript related project. I didn’t know anything about IPFS, glad I had a glimpse of it. We proceeded to shave a huge yak named Webpack but unfortunately ran out of time.&lt;/li&gt;
&lt;li&gt;Michael Nielsen gave a research talk about augmenting cognition. What is a computer, what are the possible definitions for what they enable? How can video games or (data/math) visualizations modify our cognition?&lt;/li&gt;
&lt;li&gt;Greg Price talked about his work on the upcoming PEP adding static type hints to Python.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I had a blast. Awesome week surrounded by awesome people. I kind of want to list everyone I met or hung out with but I won’t. I noticed that when you meet someone for the first time, staying in touch is really hard, almost always it’s like a good intention which takes a huge effort to fulfill. When you meet for the second time, it’s a bit easier to stay in touch afterwards.&lt;/p&gt;
&lt;p&gt;I’d like to run a little experiment regarding this. I made a list of people when leaving NYC. Staying in touch with all of them looks impossible to me, I’m always way too cautious when writing emails, it takes me ages. Perhaps I could try writing (at least) once a month to a different person from this list? To check in on their projects/work/lives/etc? (I think answering a short email whenever someone replies to one of my emails is much more feasible than attempting to write to everyone, so I could probably keep the ball rolling?)&lt;/p&gt;</content>
    
    <summary type="html">
    
      People and programming. Mainly people.
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
    
  </entry>
  
  <entry>
    <title>How Many Websites Provide RSS / Web Syndication Feeds</title>
    <link href="https://vhf.github.io/blog/2016/03/21/rss-usage-on-the-web/"/>
    <id>https://vhf.github.io/blog/2016/03/21/rss-usage-on-the-web/</id>
    <published>2016-03-21T06:20:05.000Z</published>
    <updated>2016-03-21T22:38:23.000Z</updated>
    
    <content type="html">&lt;p&gt;I became interested in web syndication feeds recently. It’s an old technology nobody talks about anymore, but everybody still provides them. Taking a look at Google Trends shows us how much people have lost interest in RSS since its peak popularity in 2006:&lt;/p&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;//www.google.com/trends/embed.js?hl=en-US&amp;q=RSS&amp;cmpt=q&amp;tz=Etc/GMT-1&amp;tz=Etc/GMT-1&amp;content=1&amp;cid=TIMESERIES_GRAPH_0&amp;export=5&amp;w=970&amp;h=330&quot;&gt;&lt;/script&gt;
&lt;p&gt;It’s an old technology people seem to have lost interest in, but can we still rely on it? Are people abandoning web syndication? With the advent of CMS (eg. the huge popularity of WordPress), static website generators and publishing platforms (eg. Medium) which all provide syndication feeds &lt;em&gt;by default&lt;/em&gt;, RSS doesn’t look dead to me.&lt;/p&gt;
&lt;p&gt;This is how I became interested in finding how many websites actually do provide at least one XML syndication feed. &lt;a href=&quot;http://trends.builtwith.com/feeds/RSS&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Builtwith&lt;/a&gt; has a pretty nifty “trends” section and it states that 33% of the 1 million most visited websites have an RSS feed. While this gives us a pretty good idea, let’s see what we could do by ourselves.&lt;/p&gt;
&lt;p&gt;We basically have two options here:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Actually crawling the web - a costly and lengthy process&lt;/li&gt;
&lt;li&gt;Relying on existing web crawl data&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Enters CommonCrawl. CommonCrawl is a non-profit founded on the exciting project of crawling tons of web pages and releasing the obtained dataset publicly and for free. Their latest dump was &lt;a href=&quot;http://commoncrawl.org/2015/12/november-2015-crawl-archive-now-available/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;published in November 2015&lt;/a&gt; and contains 1.82 billion web pages, amounting to over 151TB of highly compressed HTML. &lt;a href=&quot;/blog/2016/02/02/fixing-hiring-through-rss/#f1&quot;&gt;I half-jokingly said this before&lt;/a&gt;: why not mining CommonCrawl to answer my own question?&lt;/p&gt;
&lt;p&gt;A few weeks ago two colleagues of mine mentioned over lunch their desire to mine Common Crawl for their research, and it was a coincidence that I had been thinking about doing the same (though mostly for fun) for a few months. Wouldn’t have we been able to combine our efforts into a single “Common Crawl run”, I most probably wouldn’t have mined this dataset all by myself only to satisfy my curiosity.&lt;/p&gt;
&lt;h2 id=&quot;Working-with-CommonCrawl&quot;&gt;&lt;a href=&quot;#Working-with-CommonCrawl&quot; class=&quot;headerlink&quot; title=&quot;Working with CommonCrawl&quot;&gt;&lt;/a&gt;Working with CommonCrawl&lt;/h2&gt;&lt;p&gt;As mentioned before, the latest Common Crawl is 151TB of data hosted on S3. We decided to process it directly from a few EC2 spot instances using the &lt;a href=&quot;http://webdatacommons.org/framework/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;WDC Extraction Framework&lt;/a&gt;. Actually this choice was pretty obvious to us because the syndication feeds are not the only thing we wanted to extract from CommonCrawl. My colleagues were interested in extracting all &lt;a href=&quot;https://developers.google.com/structured-data/schema-org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;structured data&lt;/a&gt; embedded in any HTML page which is exactly what the WDC framework was designed for. We also wanted to extract all HTML anchors pointing to a Wikipedia page. We &lt;a href=&quot;https://github.com/XI-lab/WDCFramework&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;forked the WDC framework&lt;/a&gt; and modified it to extract these different things all at once, thus only needing to go through the CommonCrawl dataset once.&lt;/p&gt;
&lt;p&gt;Now, CommonCrawl dump consists of HTML web pages and we want to extract parts of it, eg. any &lt;code&gt;&amp;lt;link rel=&amp;quot;alternate&amp;quot; href=&amp;quot;/blog/atom.xml&amp;quot; title=&amp;quot;something&amp;quot; type=&amp;quot;application/atom+xml&amp;quot;&amp;gt;&lt;/code&gt; with either RSS/Atom &lt;code&gt;type&lt;/code&gt; attribute or &lt;code&gt;rel=&amp;quot;alternate&amp;quot;&lt;/code&gt; attribute. Although &lt;a href=&quot;http://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;parsing HTML with regex is a bad idea&lt;/a&gt;, constructing a full-blown DOM tree out of each of these 1.82B pages would require far too much time and processing power.&lt;/p&gt;
&lt;p&gt;Here’s the regular expression I used to match feeds:&lt;/p&gt;
&lt;figure class=&quot;highlight tex&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&amp;lt;link[^&amp;gt;]*(?:&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;s&lt;/span&gt;&lt;/span&gt;(?:type=[&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&#39;]?(application&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;rss&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;+&lt;/span&gt;&lt;/span&gt;xml|application&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;atom&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;+&lt;/span&gt;&lt;/span&gt;xml|application&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;rss|application&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;atom|application&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;rdf&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;+&lt;/span&gt;&lt;/span&gt;xml|application&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;rdf|text&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;rss&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;+&lt;/span&gt;&lt;/span&gt;xml|text&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;atom&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;+&lt;/span&gt;&lt;/span&gt;xml|text&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;rss|text&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;atom|text&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;rdf&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;+&lt;/span&gt;&lt;/span&gt;xml|text&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;rdf|text&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;xml|application&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;/&lt;/span&gt;&lt;/span&gt;xml)[&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&#39;]?|rel=[&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&#39;]?(?:alternate)[&lt;span class=&quot;tag&quot;&gt;\&lt;span class=&quot;name&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&#39;]?))[^&amp;gt;]*&amp;gt;)&quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;The WDC framework wrote its results to our S3 bucket in &lt;code&gt;csv.gz&lt;/code&gt; format. For the whole run we budgeted 500USD for AWS EC2 instances. We spawned 100 &lt;a href=&quot;https://aws.amazon.com/ec2/instance-types/#c3&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;c3.4xlarge&lt;/a&gt; EC2 instances (16 cores each) to run our modified WDC framework. Using spot instances saved us some money. It took around 30 hours to process the whole Common Crawl dump and costed less than 450USD, we were right on target.&lt;/p&gt;
&lt;p&gt;Most interesting is of course post-processing the data, not extracting it. Here is what our results S3 bucket looks like together with a short explanation of what the result of our various extractions are:&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;2.3G    /WDC_112015/anchors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60G     /WDC_112015/feeds&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54G     /WDC_112015/urls&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;346G    /WDC_112015/data&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;408G    /WDC_112015/anchor_pages&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37G     /WDC_112015/stats&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;905G    total&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;(gzipped TSV) &lt;code&gt;anchors: page_url | anchor text | wikipedia_url&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;(gzipped TSV) &lt;code&gt;feeds: page_url | link_tag | link_type&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;(gzipped TSV) &lt;code&gt;urls: page_url&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;(gzipped text) &lt;code&gt;data: &amp;lt;quintuplet&amp;gt;\n&lt;/code&gt; (subject, predicate, object, page, extractor_used)&lt;/li&gt;
&lt;li&gt;(gzipped json) &lt;code&gt;anchor_pages: {&amp;quot;url&amp;quot;: page_url, &amp;quot;content&amp;quot;: full_html_page}\n&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;(gzipped TSV) &lt;code&gt;stats: arcFileName | arcFilePos | detectedMimeType | hostIp | html-head-meta | html-mf-adr | html-mf-geo | html-mf-hcalendar | html-mf-hcard | html-mf-hlisting | html-mf-hrecipe | html-mf-hresume | html-mf-hreview | html-mf-species | html-mf-xfn | html-microdata | html-rdfa | html-rdfa11 | mimeType | recordLength | referencedData | timestamp | totalTriples | uri&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;First step was of course to sync this bucket locally and backup it to our NAS. Once this done and after having triggered security warnings at the network admins office for downloading almost 1TB at full speed, we proceeded to copy this data to &lt;a href=&quot;http://daplab.ch&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;DAPLAB&lt;/a&gt; hadoop cluster. DAPLAB is an awesome project aiming at providing a powerful data processing cluster on a freemium and premium basis for companies that cannot afford their own cluster, for researchers and scientists, etc. They also organize weekly hacking sessions to which anyone can attend and get access to the cluster for free. Our research lab has been partnering with DAPLAB since the beginning and DAPLAB infrastructure is a very nice complement to our lab’s hadoop cluster. (No more advertising in this post I promise.)&lt;/p&gt;
&lt;p&gt;We now have all the data on HDFS, let’s process it. Keep in mind this blog post is about the XML syndication feeds and not how and what we did with the other things we extracted (anchors, RDF triples, etc).&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[vfelder@daplab ~]$ hdfs dfs -ls /data/WDC_112015/data/feeds | head -n2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Found 35669 items&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1.7M 2016-02-28 15:21 /data/WDC_112015/data/feeds/ex_common-crawl_crawl-data_CC-MAIN-2015-48_segments_1448398444047.40_warc_CC-MAIN-20151124205404-00000-ip-10-71-132-137.ec2.internal.warc.gz.csv.gz&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;We have 35,669 gzipped TSV files. We don’t want to work with this format and compression because gzip is slow and CSV/TSV is not ideal to query the data. Also, 35k files is a bit too much for a ~10 nodes cluster. We will convert these 35k gzipped TSV to 1,000 snappy-compressed parquet files.&lt;/p&gt;
&lt;p&gt;Why converting 35k gunzip csv files to 1,000 snappy parquet files?&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://parquet.apache.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Parquet&lt;/a&gt; is better suited for querying (eg. using Hive) than CSV:&lt;ul&gt;
&lt;li&gt;Parquet files contain their schema, CSV don’t.&lt;/li&gt;
&lt;li&gt;Parquet files store data by column, CSV is row-based.&lt;/li&gt;
&lt;li&gt;Columns of a parquet file are compressed (each column being compressed according to its data type).&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Snappy also offers great advantages, here compared to gzip:&lt;ul&gt;
&lt;li&gt;Snappy compression is orders of magnitude faster than gzip.&lt;/li&gt;
&lt;li&gt;Snappy happily trades compression against read/write speed. After all, when running a job that loads terabytes of data from HDFS on a cluster, we care more about fast read/write than about sparing a few TB.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Less files means more throughput (as long as we have more files than processing cores of course). If we assume decompressing a file takes 100ms, the decompression alone for all 35k files will take a cumulated one hour. Of course the whole process will be distributed and run in parallel but it still constitutes overhead compared to working on only 1,000 files.&lt;/li&gt;
&lt;li&gt;We could have chosen Avro, but our schemas being very basic and our need being to query columns, Parquet made more sense.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Remember our TSV “schema” is &lt;code&gt;page_url | link_tag | link_type&lt;/code&gt;. It’s a good thing we saved the whole &lt;code&gt;&amp;lt;link&lt;/code&gt; tag because I realized after the EC2 run it might be interesting to extract a few other possible attributes. I wrote a short Scala script for Spark to extract these things &lt;strong&gt;and&lt;/strong&gt; go from &lt;code&gt;csv.gz&lt;/code&gt; to 1,000 &lt;code&gt;.snappy.parquet&lt;/code&gt;.&lt;/p&gt;
&lt;figure class=&quot;highlight scala&quot;&gt;&lt;figcaption&gt;&lt;span&gt;feedsTransform.scala&lt;/span&gt;&lt;a href=&quot;https://github.com/vhf/wdctools/blob/master/src/main/scala/info/exascale/wdctools/feedsTransform.scala&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;link&lt;/a&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; info.exascale.wdctools&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.netaporter.uri.&lt;span class=&quot;type&quot;&gt;Uri&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.types.&amp;#123;&lt;span class=&quot;type&quot;&gt;StringType&lt;/span&gt;, &lt;span class=&quot;type&quot;&gt;StructField&lt;/span&gt;, &lt;span class=&quot;type&quot;&gt;StructType&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.&amp;#123;&lt;span class=&quot;type&quot;&gt;SparkConf&lt;/span&gt;, &lt;span class=&quot;type&quot;&gt;SparkContext&lt;/span&gt;, sql&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.functions._&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; scala.language.postfixOps&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;object&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;feedsTransform&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;/span&gt;(args: &lt;span class=&quot;type&quot;&gt;Array&lt;/span&gt;[&lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; conf = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;SparkConf&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .setAppName(&lt;span class=&quot;string&quot;&gt;&quot;TransformFeeds&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .set(&lt;span class=&quot;string&quot;&gt;&quot;spark.sql.parquet.compression.codec&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;snappy&quot;&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;// snappy compression for parquet&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; sc = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;SparkContext&lt;/span&gt;(conf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; sqlContext = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; sql.&lt;span class=&quot;type&quot;&gt;SQLContext&lt;/span&gt;(sc)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// schema for the CSV we&#39;ll load&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; feedSchema = &lt;span class=&quot;type&quot;&gt;StructType&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;Array&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;type&quot;&gt;StructField&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;page&quot;&lt;/span&gt;, &lt;span class=&quot;type&quot;&gt;StringType&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;type&quot;&gt;StructField&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;tag&quot;&lt;/span&gt;, &lt;span class=&quot;type&quot;&gt;StringType&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;type&quot;&gt;StructField&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;type&quot;&lt;/span&gt;, &lt;span class=&quot;type&quot;&gt;StringType&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// read the CSV with our schema using databricks&#39; spark-csv&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; df = sqlContext&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .read&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .format(&lt;span class=&quot;string&quot;&gt;&quot;com.databricks.spark.csv&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .option(&lt;span class=&quot;string&quot;&gt;&quot;header&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;false&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .schema(feedSchema)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .load(&lt;span class=&quot;string&quot;&gt;&quot;/data/WDC_112015/data/feeds/*.csv.gz&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// extract from each page url their hostname&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// some URLs (eg. http://example.com:/foo.html) made Uri crash, I had to implement a regex&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// based check&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; hostnamePattern = &lt;span class=&quot;string&quot;&gt;&quot;((\\/\\/|https\\:\\/\\/|http\\:\\/\\/)([^\\/\\:]+))&quot;&lt;/span&gt;r&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; getHost: (&lt;span class=&quot;type&quot;&gt;String&lt;/span&gt; =&amp;gt; &lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;) = (page: &lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;) =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; preFiltered = hostnamePattern findFirstIn page&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (preFiltered.isEmpty) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        println(&lt;span class=&quot;string&quot;&gt;s&quot;prefiltering failed: &lt;span class=&quot;subst&quot;&gt;$page&lt;/span&gt;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; preFilteredString = preFiltered.get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; host = &lt;span class=&quot;type&quot;&gt;Uri&lt;/span&gt;.parse(preFilteredString).host&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (host.isEmpty) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            println(&lt;span class=&quot;string&quot;&gt;s&quot;parsing failed: &lt;span class=&quot;subst&quot;&gt;$page&lt;/span&gt; prefiltered as: &lt;span class=&quot;subst&quot;&gt;$preFilteredString&lt;/span&gt;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            host.get&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; e: &lt;span class=&quot;type&quot;&gt;Throwable&lt;/span&gt; =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; exception = e.toString&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            println(&lt;span class=&quot;string&quot;&gt;s&quot;caught &lt;span class=&quot;subst&quot;&gt;$exception&lt;/span&gt;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// extract rel=&quot;…&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; relPattern = &lt;span class=&quot;string&quot;&gt;&quot;.*rel=[\&quot;&#39;]?([^&#39;\&quot;]*)[\&quot;&#39;]?.*&quot;&lt;/span&gt;.r&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; getRel: (&lt;span class=&quot;type&quot;&gt;String&lt;/span&gt; =&amp;gt; &lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;) = (tag: &lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;) =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      tag &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// pattern-matching regex matches is so nice&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; relPattern(captured) =&amp;gt; captured&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// extract href=&quot;…&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; hrefPattern = &lt;span class=&quot;string&quot;&gt;&quot;.*href=[\&quot;&#39;]?([^&#39;\&quot;]*)[\&quot;&#39;]?.*&quot;&lt;/span&gt;.r&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; getHref: (&lt;span class=&quot;type&quot;&gt;String&lt;/span&gt; =&amp;gt; &lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;) = (tag: &lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;) =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      tag &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; hrefPattern(captured) =&amp;gt; captured&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// extract title=&quot;…&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; titlePattern = &lt;span class=&quot;string&quot;&gt;&quot;.*title=[\&quot;&#39;]?([^&#39;\&quot;]*)[\&quot;&#39;]?.*&quot;&lt;/span&gt;.r&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; getTitle: (&lt;span class=&quot;type&quot;&gt;String&lt;/span&gt; =&amp;gt; &lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;) = (tag: &lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;) =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      tag &lt;span class=&quot;keyword&quot;&gt;match&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; titlePattern(captured) =&amp;gt; captured&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// transform to lowercase&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; getLCType: (&lt;span class=&quot;type&quot;&gt;String&lt;/span&gt; =&amp;gt; &lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;) = (str: &lt;span class=&quot;type&quot;&gt;String&lt;/span&gt;) =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      str.toLowerCase&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// create spark sql user-defined functions for each of these scala function&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; sqlGetHost = udf(getHost)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; sqlGetRel = udf(getRel)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; sqlGetHref = udf(getHref)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; sqlGetTitle = udf(getTitle)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;val&lt;/span&gt; sqlGetLCType = udf(getLCType)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    df&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// add hostname column based on page column&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .withColumn(&lt;span class=&quot;string&quot;&gt;&quot;hostname&quot;&lt;/span&gt;, sqlGetHost(col(&lt;span class=&quot;string&quot;&gt;&quot;page&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// add rel column based on tag column&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .withColumn(&lt;span class=&quot;string&quot;&gt;&quot;rel&quot;&lt;/span&gt;, sqlGetRel(col(&lt;span class=&quot;string&quot;&gt;&quot;tag&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// add href column based on tag column&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .withColumn(&lt;span class=&quot;string&quot;&gt;&quot;href&quot;&lt;/span&gt;, sqlGetHref(col(&lt;span class=&quot;string&quot;&gt;&quot;tag&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// add title column based on tag column&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .withColumn(&lt;span class=&quot;string&quot;&gt;&quot;title&quot;&lt;/span&gt;, sqlGetTitle(col(&lt;span class=&quot;string&quot;&gt;&quot;tag&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// replace type column with its lowercase version&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .withColumn(&lt;span class=&quot;string&quot;&gt;&quot;type&quot;&lt;/span&gt;, sqlGetLCType(col(&lt;span class=&quot;string&quot;&gt;&quot;type&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// only output 1,000 parquet files from the 35k csv.gz input files&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .coalesce(&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// write as parquet to my hdfs home folder&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      .write.parquet(&lt;span class=&quot;string&quot;&gt;&quot;/user/vfelder/feeds/feedsparsed.parquet/&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;These 60G total / 35k &lt;code&gt;.csv.gz&lt;/code&gt;, once converted to 1k &lt;code&gt;.snappy.parquet&lt;/code&gt; with 4 additional columns, now take 187G. Not bad.&lt;/p&gt;
&lt;p&gt;We could now create a Hive table like this:&lt;/p&gt;
&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;EXTERNAL&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;TABLE&lt;/span&gt; xi_wdc.feeds (page &lt;span class=&quot;keyword&quot;&gt;STRING&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;STRING&lt;/span&gt;, tag &lt;span class=&quot;keyword&quot;&gt;STRING&lt;/span&gt;, hostname &lt;span class=&quot;keyword&quot;&gt;STRING&lt;/span&gt;, rel &lt;span class=&quot;keyword&quot;&gt;STRING&lt;/span&gt;, href &lt;span class=&quot;keyword&quot;&gt;STRING&lt;/span&gt;, title &lt;span class=&quot;keyword&quot;&gt;STRING&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;STORED&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;AS&lt;/span&gt; PARQUET LOCATION &lt;span class=&quot;string&quot;&gt;&#39;/user/vfelder/feeds/feedsparsed.parquet/&#39;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;EXTERNAL&lt;/code&gt; means the data for this table isn’t moved by Hive to the tables location, it just stays where it is and Hive loads the data directly from these files. Should we drop this table the data won’t be affected.&lt;/p&gt;
&lt;p&gt;I also performed the above &lt;code&gt;csv.gz&lt;/code&gt; to &lt;code&gt;snappy.parquet&lt;/code&gt; conversion + hostname extraction for &lt;code&gt;/data/WDC_112015/data/urls/&lt;/code&gt; which contains all crawled URLs. The Scala program to do this is very similar to the one listed here and can be found &lt;a href=&quot;https://github.com/vhf/wdctools&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Hive is nice to run some queries, but Spark SQL is equally nice and generally offers better performances. It also allows me to run queries directly from the ipython notebook I’m writing this blog post from, get the queries results and rework them directly in python.&lt;/p&gt;
&lt;p&gt;The first part of this blog post was writting in Markdown in my ipython notebook running pyspark, the rest of this post is playing with the data directly from ipython, writing pyspark.sql queries and executing them directly from ipython, running them with pyspark over the cluster.&lt;/p&gt;
&lt;p&gt;I got this handy *sh alias I’m using to spawn a notebook in a screen:&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;alias&lt;/span&gt; ipyspark=&lt;span class=&quot;string&quot;&gt;&#39;IPYTHON_OPTS=&quot;notebook --no-browser --ip=localhost --port=1339&quot; pyspark --master yarn-master --conf spark.ui.port=$(shuf -i 2000-65000 -n 1) --num-executors 20 --executor-cores 2 --driver-memory 16g --executor-memory 16g&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;Let’s-work-with-our-extracted-feeds-and-all-crawled-URLs&quot;&gt;&lt;a href=&quot;#Let’s-work-with-our-extracted-feeds-and-all-crawled-URLs&quot; class=&quot;headerlink&quot; title=&quot;Let’s work with our extracted feeds and all crawled URLs&quot;&gt;&lt;/a&gt;Let’s work with our extracted feeds and all crawled URLs&lt;/h1&gt;&lt;p&gt;First, import some spark-sql libs.&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; pyspark.sql &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; SQLContext&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; pyspark.sql.functions &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; *&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;h&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(n)&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;&quot;&quot;helper function to display numbers in a human-readable way&quot;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;:,&amp;#125;&#39;&lt;/span&gt;.format(n)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;sc&lt;/code&gt; is spark context, it’s already there because we’re running ipython on pyspark.&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sqlContext = SQLContext(sc)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;We stored the feeds and urls as snappy compressed parquet files. All we have to do is read them as parquet, everything else is taken care of.&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;feeds = sqlContext.read.parquet(&lt;span class=&quot;string&quot;&gt;&#39;/user/vfelder/feeds/feedsparsed.parquet/&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;urls = sqlContext.read.parquet(&lt;span class=&quot;string&quot;&gt;&#39;/user/vfelder/urls/urlsparsed.parquet/&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Common Crawl said their dump had 1.82B URLs, let’s check if that’s also the number of web pages we used for our extraction.&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;span class=&quot;string&quot;&gt;&#39;total number of urls&#39;&lt;/span&gt;: h(urls.count())&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;pre&gt;&lt;code&gt;{&amp;apos;total number of urls&amp;apos;: &amp;apos;1,823,130,936&amp;apos;}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Nice, it seems the data matches.&lt;/p&gt;
&lt;p&gt;Feeds and URLs files include these two columns : &lt;code&gt;page&lt;/code&gt; and &lt;code&gt;hostname&lt;/code&gt;, respectively the original URL of the web page and the hostname of this URL. A single web page can provide several feeds but we’re only interested by the number of websites which provide at least one feed, so we take the distinct hostnames. Same with URLs: we crawled a lot of URLs but we are only interested by the number of distinct hostnames, to compare the two numbers.&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;distinct_feeds_count = feeds.select(&lt;span class=&quot;string&quot;&gt;&#39;hostname&#39;&lt;/span&gt;).distinct().count()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;distinct_urls_count = urls.select(&lt;span class=&quot;string&quot;&gt;&#39;hostname&#39;&lt;/span&gt;).distinct().count()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;hostnames with at least one feed&#39;&lt;/span&gt;: h(distinct_feeds_count),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;hostnames processed&#39;&lt;/span&gt;: h(distinct_urls_count)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;pre&gt;&lt;code&gt;{&amp;apos;hostnames processed&amp;apos;: &amp;apos;25,243,438&amp;apos;,
 &amp;apos;hostnames with at least one feed&amp;apos;: &amp;apos;10,294,833&amp;apos;}
&lt;/code&gt;&lt;/pre&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;:0.2f&amp;#125;%&#39;&lt;/span&gt;.format(float(distinct_feeds_count)/distinct_urls_count*&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;pre&gt;&lt;code&gt;&amp;apos;40.78%&amp;apos;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Ok, around 40% of the crawled websites provide at least one XML feed.&lt;/p&gt;
&lt;p&gt;But on average, how many feeds per webpage?&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;total_feeds_count = feeds.count()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;total_urls_count = urls.count()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;float(total_feeds_count)/total_urls_count&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;pre&gt;&lt;code&gt;1.942656384170972
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now it would be interesting to see which standards these feeds implement.&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; pyspark.sql &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; Column&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;types_grouped = feeds&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .select(&lt;span class=&quot;string&quot;&gt;&#39;type&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .where(col(&lt;span class=&quot;string&quot;&gt;&#39;type&#39;&lt;/span&gt;) != &lt;span class=&quot;string&quot;&gt;&#39; &#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .groupBy(&lt;span class=&quot;string&quot;&gt;&#39;type&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .count()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .orderBy(desc(&lt;span class=&quot;string&quot;&gt;&#39;count&#39;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;types_grouped.show()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;pre&gt;&lt;code&gt;+--------------------+---------+
|                type|    count|
+--------------------+---------+
| application/rss+xml|877891180|
|application/atom+xml|215504961|
|     application/xml| 20276729|
|            text/xml| 17086738|
| application/rdf+xml| 14669025|
|    application/atom|   545717|
|     application/rdf|   425259|
|     application/rss|   108139|
|            text/rdf|     9637|
|        text/rss+xml|      245|
|            text/rss|      125|
|        text/rdf+xml|       14|
+--------------------+---------+
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Let’s do some basic stats:&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;rss_feeds = types_grouped&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .filter(&lt;span class=&quot;string&quot;&gt;&#39;type LIKE &quot;%rss%&quot;&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .agg(&amp;#123;&lt;span class=&quot;string&quot;&gt;&#39;count&#39;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;sum&#39;&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .collect()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rss_total = rss_feeds[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;].asDict().values()[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;atom_feeds = types_grouped&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .filter(&lt;span class=&quot;string&quot;&gt;&#39;type LIKE &quot;%atom%&quot;&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .agg(&amp;#123;&lt;span class=&quot;string&quot;&gt;&#39;count&#39;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;sum&#39;&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .collect()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;atom_total = atom_feeds[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;].asDict().values()[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;feeds_with_type = types_grouped&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .agg(&amp;#123;&lt;span class=&quot;string&quot;&gt;&#39;count&#39;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;sum&#39;&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .collect()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;feeds_with_type_total = feeds_with_type[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;].asDict().values()[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;RSS&#39;&lt;/span&gt;: h(rss_total),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;Atom&#39;&lt;/span&gt;: h(atom_total)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;pre&gt;&lt;code&gt;{&amp;apos;Atom&amp;apos;: &amp;apos;216,050,678&amp;apos;, &amp;apos;RSS&amp;apos;: &amp;apos;877,999,689&amp;apos;}
&lt;/code&gt;&lt;/pre&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;rss_pc = float(rss_total)/feeds_with_type_total*&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;atom_pc = float(atom_total)/feeds_with_type_total*&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;% RSS&#39;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;:0.2f&amp;#125;%&#39;&lt;/span&gt;.format(rss_pc),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;% Atom&#39;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;:0.2f&amp;#125;%&#39;&lt;/span&gt;.format(atom_pc),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;pre&gt;&lt;code&gt;{&amp;apos;% Atom&amp;apos;: &amp;apos;18.84%&amp;apos;, &amp;apos;% RSS&amp;apos;: &amp;apos;76.58%&amp;apos;}
&lt;/code&gt;&lt;/pre&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;alternate_total = feeds&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .select(&lt;span class=&quot;string&quot;&gt;&#39;rel&#39;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&#39;type&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .where(&lt;span class=&quot;string&quot;&gt;&#39;rel LIKE &quot;%alternate%&quot; AND (type LIKE &quot;%rss%&quot; OR type LIKE &quot;%atom%&quot;)&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .count()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;&amp;#123;:0.2f&amp;#125;%&#39;&lt;/span&gt;.format(float(alternate_total)/(rss_total+atom_total)*&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;pre&gt;&lt;code&gt;&amp;apos;97.09%&amp;apos;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;That’s about it, my questions have been answered!&lt;/p&gt;
&lt;h4 id=&quot;Let’s-quickly-recap&quot;&gt;&lt;a href=&quot;#Let’s-quickly-recap&quot; class=&quot;headerlink&quot; title=&quot;Let’s quickly recap:&quot;&gt;&lt;/a&gt;Let’s quickly recap:&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;Common Crawl is an excellent free dataset.&lt;/li&gt;
&lt;li&gt;WDC Framework is a cool tool but requires some tweaking.&lt;/li&gt;
&lt;li&gt;It is possible to extract a fair amount of data from this 151TB dump for less than 500USD of EC2.&lt;/li&gt;
&lt;li&gt;Out of 1.82B URLs we got 25.2M different hosts.&lt;/li&gt;
&lt;li&gt;Processing this data is really fast on DAPLAB’s cluster with my ipython+pyspark setup. This last (&lt;code&gt;alternate_total&lt;/code&gt;) query takes &amp;lt;10s.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;40.8% of these hostnames provide a web syndication feed.&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;RSS is the most popular syndication format by far with 76.6%, Atom is at 18.8%.&lt;/li&gt;
&lt;li&gt;97.09% of the &lt;code&gt;&amp;lt;link&lt;/code&gt; tags pointing to an RSS or Atom feed also specify &lt;code&gt;rel=&amp;quot;alternate&amp;quot;&lt;/code&gt;, as the HTML standard recommends.&lt;/li&gt;
&lt;/ul&gt;</content>
    
    <summary type="html">
    
      How to find out? Let&#39;s dig.
    
    </summary>
    
      <category term="project" scheme="https://vhf.github.io/blog/categories/project/"/>
    
      <category term="old tech new ideas" scheme="https://vhf.github.io/blog/categories/project/old-tech-new-ideas/"/>
    
    
      <category term="rss" scheme="https://vhf.github.io/blog/tags/rss/"/>
    
      <category term="spark" scheme="https://vhf.github.io/blog/tags/spark/"/>
    
      <category term="ipython" scheme="https://vhf.github.io/blog/tags/ipython/"/>
    
      <category term="scala" scheme="https://vhf.github.io/blog/tags/scala/"/>
    
  </entry>
  
  <entry>
    <title>Navigating the ECMAScript® 2015 Language Specification</title>
    <link href="https://vhf.github.io/blog/2016/02/06/navigating-the-ecmascript-2015-language-specification/"/>
    <id>https://vhf.github.io/blog/2016/02/06/navigating-the-ecmascript-2015-language-specification/</id>
    <published>2016-02-06T11:12:12.000Z</published>
    <updated>2016-02-08T19:58:17.000Z</updated>
    
    <content type="html">&lt;p&gt;Reading a language specification is not an easy thing. I thought it would be interesting to show how you can use it to explain some JavaScript questions.&lt;/p&gt;
&lt;p&gt;Here is one I encountered a few minutes ago on IRC:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;why can’t we access an array property as &lt;code&gt;xs.0&lt;/code&gt; &lt;code&gt;xs.1&lt;/code&gt; &lt;code&gt;xs.2&lt;/code&gt;?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Well, explaining the reason why &amp;mdash; the design decisions which led to this “limitation” is not so easy. Finding what the specification says, on the other hand, is not so hard.&lt;/p&gt;
&lt;p&gt;We’ll start here: &lt;a href=&quot;https://tc39.github.io/ecma262/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://tc39.github.io/ecma262/&lt;/a&gt; and we’re looking for the part which talks about accessing properties (accessing any properties, in fact).&lt;/p&gt;
&lt;p&gt;If you don’t know where to look, quickly find the &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators#Left-hand-side_expressions&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;corresponding MDN page&lt;/a&gt; and see that it’s called a “property accessor” and that it’s a left-hand-side expression.&lt;/p&gt;
&lt;p&gt;Back to the ECMAScript specification, find the index at the beginning of the page. &lt;code&gt;12.3 Left-Hand-Side Expressions&lt;/code&gt;, good. &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-property-accessors&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;12.3.2 Property Accessors&lt;/code&gt;&lt;/a&gt;, perfect!&lt;/p&gt;
&lt;p&gt;Now, we want to know what can be used as &lt;code&gt;name&lt;/code&gt; in the following syntax: &lt;code&gt;object.name&lt;/code&gt;, right? It’s pretty clear:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;MemberExpression . IdentifierName&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;But what is an &lt;code&gt;IdentifierName&lt;/code&gt;? A quick search in the page brings us to the following section: &lt;a href=&quot;https://tc39.github.io/ecma262/#sec-identifier-names&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;11.6.1 Identifier Names&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;IdentifierName ::
    IdentifierStart
    IdentifierName IdentifierPart
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We now know that an &lt;code&gt;IdentifierName&lt;/code&gt; has to start with an &lt;code&gt;IdentifierStart&lt;/code&gt;, let’s look for &lt;code&gt;IdentifierStart&lt;/code&gt; in the page…&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;IdentifierStart ::
    UnicodeIDStart
    $
    _
    \ UnicodeEscapeSequence

[...]

UnicodeIDStart ::
    any Unicode code point with the Unicode property “ID_Start”
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;An &lt;code&gt;IdentifierStart&lt;/code&gt; is either a Unicode code point with the Unicode property “ID_Start” or &lt;code&gt;$&lt;/code&gt; or &lt;code&gt;_&lt;/code&gt; or a Unicode escape sequence.&lt;/p&gt;
&lt;p&gt;Back to the original question: why can’t we do &lt;code&gt;xs.0&lt;/code&gt;?&lt;/p&gt;
&lt;p&gt;Here, &lt;code&gt;&amp;#39;0&amp;#39;&lt;/code&gt; is our &lt;code&gt;IdentifierName&lt;/code&gt; and its &lt;code&gt;IdentifierStart&lt;/code&gt; is &lt;code&gt;0&lt;/code&gt;. Since &lt;code&gt;0&lt;/code&gt; is not &lt;code&gt;$&lt;/code&gt;, &lt;code&gt;_&lt;/code&gt; or a Unicode escape sequence, it has to be a &lt;code&gt;UnicodeIDStart&lt;/code&gt; to be a valid property accessor when used with the dot notation.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;0&lt;/code&gt; is the Unicode code point &lt;code&gt;U+0030&lt;/code&gt;. Let’s see what’s in there using &lt;a href=&quot;https://codepoints.net/U+0030&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;codepoints.net&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ID Start? ✘&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;There it is. &lt;code&gt;0&lt;/code&gt; does not have the property “ID_Start”. No ID_Start ⇒ not a valid &lt;code&gt;IdentifierStart&lt;/code&gt; ⇒ not a valid &lt;code&gt;IdentifierName&lt;/code&gt; ⇒ not a valid property accessor using the dot notation.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;I’m &lt;a href=&quot;https://twitter.com/_vhf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;@_vhf&lt;/a&gt; on Twitter, feel free to follow me there.&lt;/em&gt;&lt;/p&gt;</content>
    
    <summary type="html">
    
      Finding answers to your JavaScript questions with the help of the official ECMAScript specification. Here&#39;s how.
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
      <category term="JavaScript" scheme="https://vhf.github.io/blog/categories/programming/JavaScript/"/>
    
    
      <category term="javascript" scheme="https://vhf.github.io/blog/tags/javascript/"/>
    
      <category term="es2015" scheme="https://vhf.github.io/blog/tags/es2015/"/>
    
  </entry>
  
  <entry>
    <title>The dangers of HFS+ for git repositories</title>
    <link href="https://vhf.github.io/blog/2016/02/04/the-dangers-of-hfs-for-git-repositories/"/>
    <id>https://vhf.github.io/blog/2016/02/04/the-dangers-of-hfs-for-git-repositories/</id>
    <published>2016-02-04T19:00:00.000Z</published>
    <updated>2016-02-04T19:06:07.000Z</updated>
    
    <content type="html">&lt;p&gt;HFS+ is not case sensitive. It took me 6 months to realize this basic fact. It’s one of these things you never bother researching when you consider buying a mac. Last week it hit me hard. I spent 30 minutes trying to fix something that should have been fixed in 30 seconds at most.&lt;/p&gt;
&lt;p&gt;A colleague had created &lt;code&gt;File.ext&lt;/code&gt; on our website hosted on github pages but printed &lt;code&gt;url/file.ext&lt;/code&gt; on important documents they were supposed to hand over to someone. Without access to either Internet or a printer, they asked me to fix this. Easy as pie. Except…&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ mkdir gittest &amp;amp;&amp;amp; cd gittest
$ git init
$ touch File &amp;amp;&amp;amp; ls
File
$ git add File &amp;amp;&amp;amp; git commit -m &amp;quot;add File&amp;quot;
$ mv File file &amp;amp;&amp;amp; ls
file
$ git add file &amp;amp;&amp;amp; git status
On branch master
nothing to commit, working directory clean
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Oops. At this point, I lost quite some trying different ideas. I could not believe HFS+ was case insensitive, it never even occurred to me, I thought git was playing a trick on me. I ended up doing the following:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ git rm File &amp;amp;&amp;amp; git add file
$ git commit -m &amp;quot;rename file&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The problem being fixed, I investigated a bit.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ touch a A &amp;amp;&amp;amp; ls
a
$ echo b &amp;gt; a
$ cat A
b
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I then had to get confirmation on the Internet. Of course, most developers already knew about this. I didn’t. And I currently have more than 70 repositories in my dedicated folder &lt;code&gt;~/repositories&lt;/code&gt;. Imagine if one of these had &lt;code&gt;file&lt;/code&gt; and &lt;code&gt;File&lt;/code&gt; in the same directory when I cloned it.&lt;/p&gt;
&lt;p&gt;Here is what I finally did to prevent any future headache.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ du -ch repositories | grep total
14.8G   total
$ hdiutil create -type SPARSE -fs &amp;apos;Case-sensitive Journaled HFS+&amp;apos; -size 20g ~/volume_repos.dmg
created: ~/volume_repos.dmg.sparseimage
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I then decided on a mounting point for this volume, added an alias to mount it to my rc file, created a symlink &lt;code&gt;~/repositories&lt;/code&gt; -&amp;gt; &lt;code&gt;~/mountpointrepo&lt;/code&gt;, moved my repos to the volume.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ mv repositories backup_repositories
$ echo alias mountrepos=&amp;quot;hdiutil attach ~/volume_repos.dmg.sparseimage -mountpoint /Users/victor/mountpointrepo&amp;quot; &amp;gt; .zshrc
$ source .zshrc
$ mountrepos
$ ln -s /Users/user/mountpointrepo repositories
$ cp -r backup_repositories/.* backup_repositories/* repositories
$ touch repositories/a repositories/A &amp;amp;&amp;amp; ls repositories/
A a
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Perfect. And the sparse volume will grow without my intervention to fit my &lt;code&gt;~/repositories&lt;/code&gt; content.&lt;/p&gt;
&lt;p&gt;JetBrains IDEs started complaining though:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Filesystem Case-Sensitivity Mismatch&lt;br&gt;The project seems to be located on a case-sensitive file system.&lt;br&gt;This does not match the IDE setting (controlled by property “idea.case.sensitive.fs”)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Even if their doc on this subject is very, very poor, I found the following solution:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;echo idea.case.sensitive.fs=true &amp;gt;&amp;gt; Library/Preferences/IntelliJIdea15/idea.properties
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It feels safer now though I cannot really understand why case insensitive file systems still exist in 2016. Probably because people like me buy macs, I know.&lt;/p&gt;</content>
    
    <summary type="html">
    
      OSX file system, HFS+, is case insensitive.
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
    
      <category term="osx" scheme="https://vhf.github.io/blog/tags/osx/"/>
    
      <category term="file systems" scheme="https://vhf.github.io/blog/tags/file-systems/"/>
    
  </entry>
  
  <entry>
    <title>Fixing Hiring through RSS</title>
    <link href="https://vhf.github.io/blog/2016/02/02/fixing-hiring-through-rss/"/>
    <id>https://vhf.github.io/blog/2016/02/02/fixing-hiring-through-rss/</id>
    <published>2016-02-02T16:17:17.000Z</published>
    <updated>2016-02-03T22:50:28.000Z</updated>
    
    <content type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;From: Victor Felder &amp;lt;me@example.com&amp;gt;&lt;/code&gt;&lt;br&gt;&lt;code&gt;To: &amp;lt;you@example.com&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;I’m-not-looking-for-work-thanks-for-asking&quot;&gt;&lt;a href=&quot;#I’m-not-looking-for-work-thanks-for-asking&quot; class=&quot;headerlink&quot; title=&quot;I’m not looking for work, thanks for asking!&quot;&gt;&lt;/a&gt;I’m not looking for work, thanks for asking!&lt;/h2&gt;&lt;p&gt;Really, I appreciate your attention. Both you and I know that sooner or later I’ll be looking for a job again. I understand you might need to hire someone right now. In this case, and if you’re not a recruiter, you could still find my email address on the web and take your chance if you really believe I would be a good fit. Otherwise, if you’re not in a hurry and if you consider I would still be worth hiring in a few months/years/decades or if you think I’d be an awesome colleague, here’s what you could do: Subscribe to &lt;a href=&quot;https://vhf.github.io/job.xml&quot;&gt;this RSS feed&lt;/a&gt; to get notified as soon as I’m back on the job market.&lt;/p&gt;
&lt;p&gt;Now, of course I might be stuck in an unsatisfying position and wouldn’t like my boss to be aware that I’m looking for a way out, but I don’t want to be pessimistic. I don’t have the relevant data but I’m not sure most people in my industry switch jobs without spending a few (f)unemployed weeks looking for the best option in between.&lt;/p&gt;
&lt;p&gt;Should you subscribe, here is my pledge to you:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I will not use this feed if I don’t need to. A publication on this feed will be a definitive signal of my intention of finding a new job. (Or a short message containing a new address for this feed if for whatever reason I need to move it.)&lt;/li&gt;
&lt;li&gt;I will publish something on this RSS feed as soon as I need to.&lt;/li&gt;
&lt;li&gt;It will contain a very short bio and describe what I’m looking for (in terms of position, company type/size, technology, location, part/full-time, perhaps even remuneration).&lt;/li&gt;
&lt;li&gt;It will inform you of my preferred method(s) of contact (to schedule a call, ask for a full CV, etc).&lt;br&gt;&amp;nbsp;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;This blog post is licensed under a &lt;a rel=&quot;external&quot; href=&quot;http://creativecommons.org/licenses/by/3.0/&quot; target=&quot;_blank&quot;&gt;Creative Commons Attribution 3.0 Unported License&lt;/a&gt; by Victor Felder.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;I’m &lt;a href=&quot;https://twitter.com/_vhf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;@_vhf&lt;/a&gt; on Twitter, please feel free to follow me. I’ll probably be blogging again about other RSS-related things because unlike a Norwegian Blue parrot, web feed are not dead&lt;sup id=&quot;a1&quot;&gt;&lt;a href=&quot;#f1&quot; title=&quot;Jump to footnote&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;b id=&quot;f1&quot;&gt;1&lt;/b&gt; Although (according to &lt;a href=&quot;https://www.google.com/trends/explore#q=%2Fm%2F035c93%2C%20%2Fm%2F0n5tx&amp;amp;cmpt=q&amp;amp;tz=Etc%2FGMT-1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Google Trends&lt;/a&gt;) interest for web feeds in the general public has been steadily declining since December 2005, more than a third of the top 1,000,000 most visited websites are providing an XML feed according to &lt;a href=&quot;http://trends.builtwith.com/feeds/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;builtwith&lt;/a&gt;. Please get in touch if you have relevant data, e.g. if you know whether this &amp;gt;33% statistic is in a down- or uptrend. We could even mine &lt;a href=&quot;https://commoncrawl.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Common Crawl&lt;/a&gt; for XML feeds presence with subdomain granularity. Any help much appreciated. &lt;a href=&quot;#a1&quot; title=&quot;Jump back to footnote reference&quot;&gt;↩&lt;/a&gt;&lt;/p&gt;</content>
    
    <summary type="html">
    
      What if people had feeds companies could subscribe to, to be notified when start looking for work?
    
    </summary>
    
      <category term="project" scheme="https://vhf.github.io/blog/categories/project/"/>
    
      <category term="old tech new ideas" scheme="https://vhf.github.io/blog/categories/project/old-tech-new-ideas/"/>
    
    
      <category term="rss" scheme="https://vhf.github.io/blog/tags/rss/"/>
    
      <category term="hiring" scheme="https://vhf.github.io/blog/tags/hiring/"/>
    
  </entry>
  
  <entry>
    <title>Enhancing GitHub with Chrome extensions</title>
    <link href="https://vhf.github.io/blog/2016/01/30/enhancing-github-with-chrome-extensions/"/>
    <id>https://vhf.github.io/blog/2016/01/30/enhancing-github-with-chrome-extensions/</id>
    <published>2016-01-30T17:18:18.000Z</published>
    <updated>2016-02-03T22:50:28.000Z</updated>
    
    <content type="html">&lt;p&gt;If you ever maintained a popular GitHub project, you might have suffered from a couple of things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Your GitHub news feed became &lt;a href=&quot;/images/github-feed.png&quot;&gt;useless&lt;/a&gt; because stars, issues/PR comments, wiki edits notifications were burying the notifications you were interested in in an endless flood.&lt;/li&gt;
&lt;li&gt;You spent a lot of time repeating the same things over and over on your project’s issues or PRs, such as &lt;em&gt;Thanks for your contribution! Please read the &lt;a href=&quot;https://github.com/vhf/free-programming-books/blob/master/CONTRIBUTING.md#formatting&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Formatting section of our &lt;code&gt;CONTRIBUTING.md&lt;/code&gt;&lt;/a&gt;and fix your PR accordingly.&lt;/em&gt; (While still adding a custom comment to each contributor pointing them at what they did wrong or how they can fix it, of course.)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And since we spend so much time on GitHub, why not also customizing it in some fun ways?&lt;/p&gt;
&lt;p&gt;Here are four Chrome extensions for GitHub I enjoy using – and they are all compatible with each others.&lt;/p&gt;
&lt;h3 id=&quot;dashboard-src&quot;&gt;&lt;a href=&quot;#dashboard-src&quot; class=&quot;headerlink&quot; title=&quot;dashboard (src)&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://chrome.google.com/webstore/detail/dashboard/pcnaddhmngnnpookfhhamkelhhakimdg&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;dashboard&lt;/a&gt; (&lt;a href=&quot;https://github.com/muan/dashboard&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;src&lt;/a&gt;)&lt;/h3&gt;&lt;p&gt;dashboard inserts a row of checkboxes at the top of your GitHub feed. Toggling these checkboxes show/hide specific types of notifications. For example you could use it to hide all fork notifications. Or only show new issues/PR notifications.&lt;/p&gt;
&lt;p&gt;I use it to quickly navigate in my feed.&lt;/p&gt;
&lt;h3 id=&quot;github-feed-blacklist-src&quot;&gt;&lt;a href=&quot;#github-feed-blacklist-src&quot; class=&quot;headerlink&quot; title=&quot;github-feed-blacklist (src)&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://chrome.google.com/webstore/detail/github-feed-blacklist/dbhboodpldcdeolligbmnhnjpkkolcnl&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;github-feed-blacklist&lt;/a&gt; (&lt;a href=&quot;https://github.com/vhf/github-feed-blacklist&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;src&lt;/a&gt;)&lt;/h3&gt;&lt;p&gt;dashboard is great and all but what if you only want to hide star notifications and issues/PR comments coming from a specific repository? github-feed-blacklist got your back. It adds an icon to your extensions list, clicking it provides you with a way to add (remove) repositories to the list and blacklist notifications for each repo you added by checking boxes. (Keep in mind it’s a &lt;em&gt;blacklist&lt;/em&gt;: check a box to hide, not the opposite.) To keep your feed “full”, it automatically loads the next notifications until 50 notifications are displayed. It also adds a counter at the top of your feed to tell you how many notifications have been hidden - clicking this counter will temporarily show them all. The UI is kinda ugly but heh, I’m no design ninja.&lt;/p&gt;
&lt;p&gt;I use it to mute specific notification types coming from specific repos.&lt;/p&gt;
&lt;h3 id=&quot;GitHub-Canned-Responses-src&quot;&gt;&lt;a href=&quot;#GitHub-Canned-Responses-src&quot; class=&quot;headerlink&quot; title=&quot;GitHub Canned Responses (src)&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://chrome.google.com/webstore/detail/github-canned-responses/lhehmppafakahahobaibfcomknkhoina&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GitHub Canned Responses&lt;/a&gt; (&lt;a href=&quot;https://github.com/notwaldorf/github-canned-responses&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;src&lt;/a&gt;)&lt;/h3&gt;&lt;p&gt;GitHub Canned Responses adds a button inside the issues/PR comment form. Activating it will allow you to insert a predefined answer in the comment form. The saved canned answers list can be edited to modify the existing ones, add your own or delete the ones you don’t need.&lt;/p&gt;
&lt;p&gt;I intend to use it to insert repetitive answers to the PRs I got, I’m sure it will prove particularly useful to avoid having to explain the same stuff over and over again, for example to tell people that a failed Travis run on a PR means they should go check Travis’ logs and actually fix their commits or ask for help.&lt;/p&gt;
&lt;h3 id=&quot;Isometric-Contributions-src&quot;&gt;&lt;a href=&quot;#Isometric-Contributions-src&quot; class=&quot;headerlink&quot; title=&quot;Isometric Contributions (src)&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://chrome.google.com/webstore/detail/isometric-contributions/mjoedlfflcchnleknnceiplgaeoegien&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Isometric Contributions&lt;/a&gt; (&lt;a href=&quot;https://github.com/jasonlong/isometric-contributions&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;src&lt;/a&gt;)&lt;/h3&gt;&lt;p&gt;Isometric Contributions is the fun one. It does not serve a particularly useful purpose. All it does is rendering a GitHub user contribution graph (the small squares you keep abusing to draw cat emojis or propose to your SO, you know) as isometric pixel art. And it’s beautiful.&lt;/p&gt;
&lt;p&gt;Please tweet me &lt;a href=&quot;https://twitter.com/_vhf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;@_vhf&lt;/code&gt;&lt;/a&gt;if you think I forgot your favorite GitHub Chrome extension!&lt;/p&gt;</content>
    
    <summary type="html">
    
      GitHub lacks a few features which might be useful for popular projects maintainers. Here are some helpful Chrome extensions.
    
    </summary>
    
      <category term="project" scheme="https://vhf.github.io/blog/categories/project/"/>
    
      <category term="tools" scheme="https://vhf.github.io/blog/categories/project/tools/"/>
    
    
      <category term="chrome" scheme="https://vhf.github.io/blog/tags/chrome/"/>
    
      <category term="github" scheme="https://vhf.github.io/blog/tags/github/"/>
    
  </entry>
  
  <entry>
    <title>Chromium, Chrome, Node.js, V8, Crankshaft and bailout reasons</title>
    <link href="https://vhf.github.io/blog/2016/01/22/chromium-chrome-v8-crankshaft-bailout-reasons/"/>
    <id>https://vhf.github.io/blog/2016/01/22/chromium-chrome-v8-crankshaft-bailout-reasons/</id>
    <published>2016-01-22T19:20:20.000Z</published>
    <updated>2016-02-03T22:50:28.000Z</updated>
    
    <content type="html">&lt;p&gt;This post is a short summary about all these terms, with a rough description of how V8 works. (It’s rather an overview of how Crankshaft works, really.)&lt;/p&gt;
&lt;h2 id=&quot;Chromium-Chrome-Node-js&quot;&gt;&lt;a href=&quot;#Chromium-Chrome-Node-js&quot; class=&quot;headerlink&quot; title=&quot;Chromium, Chrome, Node.js&quot;&gt;&lt;/a&gt;Chromium, Chrome, Node.js&lt;/h2&gt;&lt;p&gt;The Chromium Project is responsible for Chromium’s development. Chromium, released in 2008, is the open-source web browser on which Google Chrome is based. Chromium’s JavaScript engine is V8. Other projects such as the Opera web browser and the Node.js runtime use V8 as their JavaScript engine.&lt;/p&gt;
&lt;h2 id=&quot;V8&quot;&gt;&lt;a href=&quot;#V8&quot; class=&quot;headerlink&quot; title=&quot;V8&quot;&gt;&lt;/a&gt;V8&lt;/h2&gt;&lt;p&gt;V8 compiles JavaScript to native machine code and executes it right away. In 2010, the Chromium Project released a new version of V8 including a new compiling infrastructure named Crankshaft (&lt;a href=&quot;https://en.wikipedia.org/wiki/Chromium_(web_browser)&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;#1&lt;/a&gt;, &lt;a href=&quot;https://en.wikipedia.org/wiki/V8_(JavaScript_engine)&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;#2&lt;/a&gt;).&lt;/p&gt;
&lt;h2 id=&quot;Crankshaft-and-bailouts&quot;&gt;&lt;a href=&quot;#Crankshaft-and-bailouts&quot; class=&quot;headerlink&quot; title=&quot;Crankshaft and bailouts&quot;&gt;&lt;/a&gt;Crankshaft and bailouts&lt;/h2&gt;&lt;p&gt;The three most important components of Crankshaft are:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;the base compiler, which compiles JavaScript to machine code as fast as possible without even trying to optimize most of the things,&lt;/li&gt;
&lt;li&gt;the runtime profiler, which tracks how much time is spent running which parts of code and identifies &lt;em&gt;hot code&lt;/em&gt;, i.e. code worth spending time optimizing, and&lt;/li&gt;
&lt;li&gt;the optimizing compiler, which attempts to optimize the previously identified hot code.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Optimizing the JavaScript is always a tradeoff. We want both fast loading pages and fast running code, i.e. low start-up time and peak performance. Low start-up time is achieved by the base compiler: V8 compiles and runs the code as soon as it gets it. Peak performance is achieved by the optimizing compiler: Crankshaft optimizes the hot code. Optimizing before first running the code is not a good idea because optimizing takes time which would slow down start-up time. Also, running the unoptimized code allows Crankshaft to gather useful data about &lt;em&gt;how&lt;/em&gt; to optimize it.&lt;/p&gt;
&lt;p&gt;When the optimizing compiler gets to work, it makes optimistic assumptions about the code it’s optimizing, meaning that it assumes it’s optimizable and does its best.&lt;/p&gt;
&lt;p&gt;In some cases, the runtime data (e.g. type information) provided by the base compiler to the optimizing compiler didn’t cover some (edge) cases and the optimizing compiler sends V8 back to run the base compiler compiled code. This is known as a &lt;em&gt;deopt&lt;/em&gt;. Later on, the same hot code will be fed to the optimizing compiler again with more runtime data, and could eventually succeed its optimization attemps. If it fails more than 10 times, it will give up with the following bailout reason: “&lt;a href=&quot;https://github.com/vhf/v8-bailout-reasons#optimized-too-many-times&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Optimized too many times&lt;/a&gt;“&lt;/p&gt;
&lt;p&gt;In some other cases, the optimizing compiler receives code that contains JavaScript features (such as &lt;code&gt;try...catch&lt;/code&gt; statements) it doesn’t support, or the code doesn’t respect &lt;a href=&quot;/2016/01/15/one-simple-trick-for-javascript-performance-optimization/&quot;&gt;some limits&lt;/a&gt; set by the optimizing compiler. In this case, the optimizing compiler will also fall back to the base compiler compiled code. This is known as a &lt;em&gt;bailout&lt;/em&gt; (because the optimizing compiler bails out on his optimization attempt), and whenever it happens Crankshaft is kind enough to give us a reason why the bailout happened.&lt;/p&gt;
&lt;p&gt;This repo lists all these bailout reasons: &lt;a href=&quot;https://github.com/vhf/v8-bailout-reasons&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;V8 bailout reasons&lt;/a&gt;. The aim of this project is to provide insights by reproducing most of them, explaining why they happened and how to avoid them.&lt;/p&gt;
&lt;p&gt;A function which gets optimized can run 100x faster, meaning that it’s kind of wise to learn about these bailout patterns to best avoid them if you care about the JavaScript performances of the code you run on V8 (for instance if you target Chromium/Chrome, Node.js or Opera).&lt;/p&gt;
&lt;p&gt;I’ll most probably write a follow up about TurboFan -the new V8 JavaScript optimizing compiler- and what it brings to the table.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;References on this subject: &lt;a href=&quot;http://blog.chromium.org/2010/12/new-crankshaft-for-v8.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;#3&lt;/a&gt;, &lt;a href=&quot;https://github.com/GoogleChrome/devtools-docs/issues/53&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;#4&lt;/a&gt;, &lt;a href=&quot;https://github.com/petkaantonov/bluebird/wiki/Optimization-killers&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;#5&lt;/a&gt;, &lt;a href=&quot;http://thibaultlaurens.github.io/javascript/2013/04/29/how-the-v8-engine-works/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;#6&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;</content>
    
    <summary type="html">
    
      A short summary about these terms, an overview of how V8 / Crankshaft works.
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
      <category term="JavaScript" scheme="https://vhf.github.io/blog/categories/programming/JavaScript/"/>
    
    
      <category term="v8" scheme="https://vhf.github.io/blog/tags/v8/"/>
    
      <category term="crankshaft" scheme="https://vhf.github.io/blog/tags/crankshaft/"/>
    
      <category term="javascript" scheme="https://vhf.github.io/blog/tags/javascript/"/>
    
      <category term="es2015" scheme="https://vhf.github.io/blog/tags/es2015/"/>
    
      <category term="nodejs" scheme="https://vhf.github.io/blog/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>Chrome 49 is coming, with 92% ES2015 coverage!</title>
    <link href="https://vhf.github.io/blog/2016/01/21/Chrome-49-is-coming-with-92-ES2015-coverage/"/>
    <id>https://vhf.github.io/blog/2016/01/21/Chrome-49-is-coming-with-92-ES2015-coverage/</id>
    <published>2016-01-21T20:53:35.000Z</published>
    <updated>2016-02-03T22:50:28.000Z</updated>
    
    <content type="html">&lt;p&gt;December 11, Chrome 49 landed on the Dev channel. This week, with already &lt;a href=&quot;https://googlechromereleases.blogspot.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;two new releases of Chrome 49&lt;/a&gt; to the Dev channel, the process seems to intensify.&lt;/p&gt;
&lt;p&gt;On Tuesday &lt;a href=&quot;http://seththompson.org&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Seth Thompson&lt;/a&gt;, who works on V8, &lt;a href=&quot;https://news.ycombinator.com/item?id=10932790&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;wrote on HN&lt;/a&gt; that “V8 now has 92% ES6 coverage in Chrome Canary (on track for shipping in Chrome M49)!”&lt;/p&gt;
&lt;p&gt;kangax’ awesome &lt;a href=&quot;http://kangax.github.io/compat-table/es6/#chrome49&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ECMAScript compatibility table&lt;/a&gt; is already up to date, and Chrome 49’s column looks very green indeed.&lt;/p&gt;
&lt;p&gt;Since I talked about both optimizing &lt;strong&gt;rest parameters&lt;/strong&gt; in Babel (&lt;a href=&quot;https://vhf.github.io/blog/2015/11/02/javascript-performance-with-babel-and-node-js/&quot;&gt;#1&lt;/a&gt;, &lt;a href=&quot;https://vhf.github.io/blog/2015/12/17/making-babel-fast-with-rest-parameters/&quot;&gt;#2&lt;/a&gt;) and &lt;strong&gt;&lt;a href=&quot;https://github.com/vhf/v8-bailout-reasons&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;V8 bailout reasons&lt;/a&gt;&lt;/strong&gt; (&lt;a href=&quot;https://vhf.github.io/blog/2016/01/15/one-simple-trick-for-javascript-performance-optimization/&quot;&gt;#3&lt;/a&gt;, &lt;a href=&quot;https://vhf.github.io/blog/2015/11/02/javascript-performance-with-babel-and-node-js/&quot;&gt;#1&lt;/a&gt;, &lt;a href=&quot;https://vhf.github.io/blog/2015/12/17/making-babel-fast-with-rest-parameters/&quot;&gt;#2&lt;/a&gt;) on this blog, I thought I would look into it again.&lt;/p&gt;
&lt;p&gt;The upcoming version of V8 does support rest parameters, and that’s awesome! But Crankshaft bails out when it encounters one of them (&lt;a href=&quot;https://chromium.googlesource.com/v8/v8/+/d3f074b23195a2426d14298dca30c4cf9183f203%5E%21/src/bailout-reason.h&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;#4&lt;/a&gt;) instead of optimizing your function, and that’s less awesome. But the engineer who introduced this bailout said (&lt;a href=&quot;https://codereview.chromium.org/1272673003&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;#5&lt;/a&gt;) they will be optimized by TurboFan instead, awesome again! (He even hinted that all currently “unsafe” usages of the &lt;code&gt;arguments&lt;/code&gt; object will be optimized, and that’s &lt;em&gt;very awesome&lt;/em&gt;!)&lt;/p&gt;
&lt;p&gt;In the meantime, before all of these ES2015 features land in Node, before TurboFan comes in handy, I guess I’ll keep using Babel’s &lt;code&gt;transform-es2015-parameters&lt;/code&gt; for my Node code.&lt;/p&gt;</content>
    
    <summary type="html">
    
      It&#39;s coming, it&#39;s awesome, but some features might still be worth transpiling.
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
      <category term="JavaScript" scheme="https://vhf.github.io/blog/categories/programming/JavaScript/"/>
    
    
      <category term="v8" scheme="https://vhf.github.io/blog/tags/v8/"/>
    
      <category term="crankshaft" scheme="https://vhf.github.io/blog/tags/crankshaft/"/>
    
      <category term="javascript" scheme="https://vhf.github.io/blog/tags/javascript/"/>
    
      <category term="es2015" scheme="https://vhf.github.io/blog/tags/es2015/"/>
    
      <category term="nodejs" scheme="https://vhf.github.io/blog/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>Modifying or Deleting a Line from an Old Commit</title>
    <link href="https://vhf.github.io/blog/2016/01/20/modifying-or-deleting-a-line-from-an-old-commit/"/>
    <id>https://vhf.github.io/blog/2016/01/20/modifying-or-deleting-a-line-from-an-old-commit/</id>
    <published>2016-01-20T22:59:59.000Z</published>
    <updated>2016-02-03T22:50:28.000Z</updated>
    
    <content type="html">&lt;p&gt;I’ll spare you and assume you know what you’re doing, so here’s the short version. Keep reading for a more comprehensive one.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Find the commit you want to change or delete&lt;/li&gt;
&lt;li&gt;Get the SHA of its parent commit.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;git rebase -i 1a2b3c4d&lt;/code&gt; (1a2b3c4d is the parent)&lt;/li&gt;
&lt;li&gt;Replace &lt;code&gt;pick&lt;/code&gt; with &lt;code&gt;edit&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;git add yourfile&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;git commit --amend&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;git rebase --continue&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I work alone on most of my side projects. They are experiments, personal documentations, &lt;del&gt;stupid&lt;/del&gt; ideas… they have something in common though, they are versioned using git and I’m often their only contributor. Which means that if I want to rewrite the history and &lt;code&gt;git push --force&lt;/code&gt;, I can! It won’t break someone else’s work!&lt;/p&gt;
&lt;p&gt;Maybe I shouldn’t have stricken out &lt;em&gt;stupid&lt;/em&gt; here. Two months ago I had an idea. It came out of nowhere and was very easy to do, so I did it. &lt;em&gt;Let’s log the content of my clipboard every minute!&lt;/em&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;* * * * * &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; ~/repositories/clipboard/ &amp;amp;&amp;amp; pbpaste &amp;gt; clipboard.txt &amp;amp;&amp;amp; git aa &amp;amp;&amp;amp; git commit -m &lt;span class=&quot;string&quot;&gt;&quot;`date`&quot;&lt;/span&gt; 2&amp;gt;&amp;amp;1 &amp;gt;/dev/null&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;This idea being stupid and/or useless does not mean I &lt;em&gt;am&lt;/em&gt; stupid or useless, I was obviously not going to push this to a remote server.&lt;/p&gt;
&lt;p&gt;But let’s pretend I’d like to anyway. We can very safely assume that doing so would be very unsafe: there are probably a bunch of my passwords in the repo (copy-pasted from my password manager), and private emails (written in my text editor and copy-pasted to my webmail), and kilobytes of source code I wrote at work, etc.&lt;/p&gt;
&lt;p&gt;Obviously, trying to delete all potential private data from my clipboard repo would be a hard and painful process of carefully reviewing the content of each of the thousands of commits it contains.&lt;/p&gt;
&lt;p&gt;So for the sake of the demonstration, and because I used this post as an excuse to tell you about the futility of logging your clipboard, or because I used the futility of logging my clipboard to blog about how to change / delete an old commit, here’s how you could achieve the removal of &lt;code&gt;mysecret&lt;/code&gt; from your git repo without leaving any trace (given that nobody cloned or forked your repo):&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Find the commit you want to change or delete:&lt;ul&gt;
&lt;li&gt;If you already know the commit SHA, easy.&lt;/li&gt;
&lt;li&gt;If you know the commit message, &lt;code&gt;git log --grep=&amp;#39;Versioning my secret&amp;#39; # --all for all branches&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;If you know the commit content, &lt;code&gt;git grep mysecret $(git rev-list --all)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;If you know which file contains your secret, &lt;code&gt;git blame file&lt;/code&gt;, find line, get SHA, checkout SHA, blame, repeat until you get the first commit introducing the secret (don’t settle for the 20 following commits fiddling with this line’s whitespaces).&lt;/li&gt;
&lt;li&gt;Choose whatever option gets you the SHA the quickest. The order listed here is not that bad in my opinion. So, your secret first appeared in your git repository at commit &lt;code&gt;054f345865f8f5a319dc05fcfa6cf9b76541e229&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;You actually need the SHA of the previous commit (parent commit). The commit that came directly before the one you want to modify or get rid of.&lt;ul&gt;
&lt;li&gt;&lt;code&gt;git rev-list --all | grep 054f345865f8f5a319dc05fcfa6cf9b76541e229 -A1 | tail -n1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;So, the parent is &lt;code&gt;e20645764ce6419e348e6c1b5dea2348e18d050f&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;We will use the parent as rebase starting point, meaning our bad commit will be the first one in the rebase process.&lt;ul&gt;
&lt;li&gt;&lt;code&gt;git rebase -i e20645764ce6419e348e6c1b5dea2348e18d050f&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;The first line should be your “bad” commit: &lt;code&gt;pick 054f345 versioning secret stuff!&lt;/code&gt;&lt;ul&gt;
&lt;li&gt;Replace &lt;code&gt;pick&lt;/code&gt; with &lt;code&gt;edit&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Close the editor to start rebasing.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Your repo is now at the bad commit. Edit &lt;code&gt;yourfile&lt;/code&gt; and remove your secret from it. Or delete &lt;code&gt;yourfile&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;git add yourfile&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;git commit --amend&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;git rebase --continue&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Done!&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Note that if you simply want to &lt;em&gt;delete the bad commit&lt;/em&gt; instead of &lt;em&gt;editing it to remove a secret from a file or remove a file from the commit&lt;/em&gt;, this won’t work. Simply drop the commit when rebasing instead of &lt;code&gt;edit&lt;/code&gt;ing it.&lt;/p&gt;
&lt;p&gt;The first time I had to do that it took me quite some time to figure it out, and search engines weren’t that helpful.&lt;/p&gt;
&lt;p&gt;If you have a complex history and would like to edit a bad merge or other weird cases AND if you like &lt;em&gt;choose your own adventure&lt;/em&gt; books, take a look at this: &lt;a href=&quot;http://sethrobertson.github.io/GitFixUm/fixup.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://sethrobertson.github.io/GitFixUm/fixup.html&lt;/a&gt;. It’s as awesome as it’s hard to navigate! :)&lt;/p&gt;
&lt;p&gt;PS: I’m not responsible if you rewrite the history of a publicly traded github repository.&lt;br&gt;PPS: I’m now the very proud owner of a very useless domain name: &lt;a href=&quot;http://☑.ml&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;☑.ml&lt;/a&gt;. (You can even append &lt;code&gt;/blog/&lt;/code&gt; to get here. UTF-8 works!) Finally a URL I could handwrite without worrying about my handwriting (while worrying about the poor people who will try to type it in their browser instead)!&lt;/p&gt;</content>
    
    <summary type="html">
    
      Here&#39;s how. But seriously, you probably shouldn&#39;t do it.
    
    </summary>
    
    
      <category term="git" scheme="https://vhf.github.io/blog/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>One Simple Trick for JavaScript Performance Optimization</title>
    <link href="https://vhf.github.io/blog/2016/01/15/one-simple-trick-for-javascript-performance-optimization/"/>
    <id>https://vhf.github.io/blog/2016/01/15/one-simple-trick-for-javascript-performance-optimization/</id>
    <published>2016-01-15T00:20:12.000Z</published>
    <updated>2016-02-03T22:50:28.000Z</updated>
    
    <content type="html">&lt;p&gt;Sorry for the clickbait. It’s so omnipresent these days, I &lt;em&gt;had&lt;/em&gt; to try it. 90% of my daily Medium digest and 90% of my Pocket recommendations are like this. Note to self: write some kind of clickbait filtering software. Obtaining a huge training set should &lt;strong&gt;not&lt;/strong&gt; be an issue. (We could even crowdsource these! How fun!)&lt;/p&gt;
&lt;p&gt;Anyway. If you follow my blog (and I’m not sure you should), you might have guessed that I’m currently having fun with V8’s optimizing compiler, an awesome piece of software romantically called Crankshaft. Basically, it’s what makes JavaScript fast on Chrome/nodejs.&lt;/p&gt;
&lt;p&gt;Most of the time Crankshaft is able to optimize JavaScript functions. They then run really fast.&lt;/p&gt;
&lt;p&gt;In some cases, Crankshaft doesn’t optimize a function. It simply gets to a function and bails out instead of trying to optimize it. Whenever this happens, it invokes a &lt;strong&gt;bailout reason&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Documentation on these bailout reasons are very scarce, so Wednesday I decided to list them all and try to reproduce each of them, documenting why it occurs, giving advice on how to avoid the bailout, and give real-life examples of where it can be spotted.&lt;/p&gt;
&lt;p&gt;As of the writing of this post, I was only able to partially document 8 of them. I have more material but need more research/more time.&lt;/p&gt;
&lt;p&gt;If you’d like to see what I got and to contribute your awesome V8 knowledge, please see &lt;strong&gt;&lt;a href=&quot;https://github.com/vhf/v8-bailout-reasons&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;V8 bailout reasons&lt;/a&gt;&lt;/strong&gt; on GitHub.&lt;/p&gt;
&lt;p&gt;But I didn’t make you read all this for nothing. In the title of this post I made a promise I intend to fulfill, so here is…&lt;/p&gt;
&lt;h3 id=&quot;One-Simple-Trick-for-JavaScript-Performance-Optimization&quot;&gt;&lt;a href=&quot;#One-Simple-Trick-for-JavaScript-Performance-Optimization&quot; class=&quot;headerlink&quot; title=&quot;One Simple Trick for JavaScript Performance Optimization&quot;&gt;&lt;/a&gt;One Simple Trick for JavaScript Performance Optimization&lt;/h3&gt;&lt;p&gt;Don’t use more than &lt;del&gt;65535&lt;/del&gt; 512 parameters in a single JavaScript function. Otherwise, Crankshaft will bail out with the following informative message: “Too many parameters.”&lt;/p&gt;
&lt;h4 id=&quot;How-can-I-fix-my-JavaScript-code-to-make-it-run-blazingly-fast&quot;&gt;&lt;a href=&quot;#How-can-I-fix-my-JavaScript-code-to-make-it-run-blazingly-fast&quot; class=&quot;headerlink&quot; title=&quot;How can I fix my JavaScript code to make it run blazingly fast?&quot;&gt;&lt;/a&gt;How can I fix my JavaScript code to make it run blazingly fast?&lt;/h4&gt;&lt;p&gt;Stick to 511 parameters (or less).&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;511 is a good-looking number. In unicode, it looks really really good: &amp;#511;&lt;/li&gt;
&lt;li&gt;A function with 511 parameters always looks better than a function with 512 parameters. (I have discovered a truly remarkable proof which this margin is too small to contain.)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;Note: I originally wrote this article with 65535 instead of 512. I did not pay enough attention while reading V8 source code. It was 65535 bits, i.e. 512 bytes, or 512 parameters. Not 65535 parameters. &lt;a href=&quot;https://github.com/vhf/concise-notes/commit/88fc535cbe23a567ddd3e65f8f64c6590936a51b&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Review the diff&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;</content>
    
    <summary type="html">
    
      My attempt at clickbait. Also, an interesting (who said &quot;useless&quot;) JS performance tip.
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
      <category term="JavaScript" scheme="https://vhf.github.io/blog/categories/programming/JavaScript/"/>
    
    
      <category term="v8" scheme="https://vhf.github.io/blog/tags/v8/"/>
    
      <category term="crankshaft" scheme="https://vhf.github.io/blog/tags/crankshaft/"/>
    
      <category term="javascript" scheme="https://vhf.github.io/blog/tags/javascript/"/>
    
      <category term="nodejs" scheme="https://vhf.github.io/blog/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>Comment Syntax in Programming Languages (and the Eye of Osiris)</title>
    <link href="https://vhf.github.io/blog/2016/01/13/comment-syntax-in-programming-languages/"/>
    <id>https://vhf.github.io/blog/2016/01/13/comment-syntax-in-programming-languages/</id>
    <published>2016-01-13T18:19:19.000Z</published>
    <updated>2016-02-12T11:42:06.000Z</updated>
    
    <content type="html">&lt;p&gt;I witnessed an uncommon debate the other day. Someone was asking why programming languages don’t agree on a common syntax for comments.&lt;/p&gt;
&lt;p&gt;Besides the usual indifferent answers such as “why would they”, “why should they”, and “it doesn’t matter in the least”, a couple of points were made:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;When designing a programming language, discussing the comment syntax is the ultimate form of &lt;a href=&quot;https://en.wikipedia.org/wiki/Bikeshedding&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;bikeshedding&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;An interesting corollary of &lt;em&gt;Parkinson’s law of triviality&lt;/em&gt; is &lt;a href=&quot;https://wiki.haskell.org/Wadler&amp;#39;s_Law&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Wadler’s law of language design&lt;/a&gt;, stating that when designing a programming language “twice as much time is spent discussing syntax than semantics, twice as much time is spent discussing lexical syntax than syntax, and twice as much time is spent discussing syntax of comments than lexical syntax.”&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In conclusion, why not just rip off &lt;a href=&quot;https://vimeo.com/111122950&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Sketchy JS&lt;/a&gt;‘ “Eye of Osiris” operator syntax introduced by James Mickens?&lt;/p&gt;
&lt;p class=&quot;pre-fake&quot;&gt;{[~æ&lt;br&gt;this is a comment&lt;br&gt;*$€&lt;img src=&quot;/blog/images/beyonce.jpg&quot; alt=&quot;Beyonce&quot; style=&quot;margin:none!important;display:inline-block;height:37px;width:39px;vertical-align:text-top&quot;&gt;&lt;/p&gt;
&lt;p&gt;(A curly brace, a square brace, a squiggle, and the combined AE character. Place your comment after the first part of the Eye of Osiris and close the Eye of Osiris using an asterisk, a dollar sign, a euro sign, and a tiny picture of Beyonce.)&lt;/p&gt;</content>
    
    <summary type="html">
    
      Wadler&#39;s law is bikeshedding applied to programming languages design.
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
    
      <category term="programming language design" scheme="https://vhf.github.io/blog/tags/programming-language-design/"/>
    
  </entry>
  
  <entry>
    <title>Making Babel fast with ES2015 rest parameters</title>
    <link href="https://vhf.github.io/blog/2015/12/17/making-babel-fast-with-rest-parameters/"/>
    <id>https://vhf.github.io/blog/2015/12/17/making-babel-fast-with-rest-parameters/</id>
    <published>2015-12-17T12:36:59.000Z</published>
    <updated>2016-02-03T22:50:28.000Z</updated>
    
    <content type="html">&lt;p&gt;This post is a follow-up of &lt;a href=&quot;http://vhf.github.io/blog/2015/11/02/javascript-performance-with-babel-and-node-js/&quot;&gt;JavaScript performance with Babel and Node.js: a case against default parameters in tail call optimizations&lt;/a&gt;. At the time, Babel 6 had only been published for a few hours.&lt;/p&gt;
&lt;p&gt;When Babel 6 was released, I quickly realised that I kind of missed my target: tail call optimisation had been dropped in the process. But all was not lost, I could still investigate Babel’s use of &lt;code&gt;arguments&lt;/code&gt;.&lt;/p&gt;
&lt;h1 id=&quot;Fixture-tests&quot;&gt;&lt;a href=&quot;#Fixture-tests&quot; class=&quot;headerlink&quot; title=&quot;Fixture tests&quot;&gt;&lt;/a&gt;Fixture tests&lt;/h1&gt;&lt;p&gt;First, I looked at a lot of fixture tests. These are files meant to test if a particular Babel transform or plug-in works properly. They consist of two files: &lt;code&gt;actual.js&lt;/code&gt; (ES2015 code) and &lt;code&gt;expected.js&lt;/code&gt;. The goal of this test is to check if the output of &lt;code&gt;babel actual.js&lt;/code&gt; matches the content of &lt;code&gt;expected.js&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I noticed something about a particular transform : &lt;code&gt;babel-plugin-transform-es2015-parameters&lt;/code&gt;, more precisely about its handling of &lt;code&gt;rest&lt;/code&gt; parameters:&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;actual.js&lt;/span&gt;&lt;a href=&quot;https://github.com/babel/babel/blob/82ddbc0ecd9a16fdb173bbcf85bc10ade6f9828d/packages/babel-plugin-transform-es2015-parameters/test/fixtures/parameters/rest-arrow-functions/actual.js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;link&lt;/a&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; concat = (...arrs) =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; x = arrs[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; y = arrs[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;expected.js&lt;/span&gt;&lt;a href=&quot;https://github.com/babel/babel/blob/82ddbc0ecd9a16fdb173bbcf85bc10ade6f9828d/packages/babel-plugin-transform-es2015-parameters/test/fixtures/parameters/rest-arrow-functions/expected.js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;link&lt;/a&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; concat = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; (&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; x = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; y = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;This is unsafe. V8 will only be able to optimise the &lt;code&gt;concat&lt;/code&gt; function if the &lt;code&gt;arguments&lt;/code&gt; object has a length greater than 1. Otherwise, for example &lt;code&gt;concat([0])&lt;/code&gt;, the attempt to access the undefined &lt;code&gt;arguments[1]&lt;/code&gt; will force V8 to rematerialize &lt;code&gt;arguments&lt;/code&gt; on the fly, preventing the whole function from being optimised.&lt;/p&gt;
&lt;h1 id=&quot;First-attempt&quot;&gt;&lt;a href=&quot;#First-attempt&quot; class=&quot;headerlink&quot; title=&quot;First attempt&quot;&gt;&lt;/a&gt;First attempt&lt;/h1&gt;&lt;p&gt;Having no idea about Babel’s codebase and internals, it took me a whole weekend to come up with a first patch: &lt;a href=&quot;https://github.com/babel/babel/pull/2833&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;#2833: Have es2015 rest transform safely use &lt;code&gt;arguments&lt;/code&gt;&lt;/a&gt;. It fixed some of the rest-transformed unsafe use of &lt;code&gt;arguments&lt;/code&gt; and it got merged after five weeks (which is way too long by the way, but I don’t blame anyone, I’m pretty sure it was an exceptional situation where someone said they would take care of this PR, then got busy, and in the meantime nobody saw the need to take over because someone was already in charge. No big deal).&lt;/p&gt;
&lt;p&gt;At first I was pretty happy with this patch. The new &lt;code&gt;expected.js&lt;/code&gt; looked like this:&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;expected.js&lt;/span&gt;&lt;a href=&quot;https://github.com/babel/babel/blob/9a97d92217dffcf6478611067c1525fa4004fce4/packages/babel-plugin-transform-es2015-parameters/test/fixtures/parameters/rest-arrow-functions/expected.js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;link&lt;/a&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; concat = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; (&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; x = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;.length &amp;lt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] === &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt; ? &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt; : &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; y = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;.length &amp;lt;= &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; || &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] === &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt; ? &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt; : &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;which was safe. Some basic benchmarks were showing a 4x speedup. The tests were green. I had learned a lot about how Babel works.&lt;/p&gt;
&lt;p&gt;Until &lt;a href=&quot;https://github.com/babel/babel/pull/2833#discussion_r47472444&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;someone noticed the pattern I was using was a bit weird&lt;/a&gt;. In fact, the reason I initially chose this pattern was that I got it from &lt;a href=&quot;https://github.com/babel/babel/blob/master/packages/babel-plugin-transform-es2015-parameters/src/default.js#L8-L11&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;here&lt;/a&gt;. While it makes sense to use it for default parameters handling (&lt;code&gt;ARGUMENTS.length &amp;lt;= INDEX || ARGUMENTS[INDEX] === undefined ? DEFAULT_VALUE : ARGUMENTS[INDEX];&lt;/code&gt;), it becomes overly complicated in the case where &lt;code&gt;DEFAULT_VALUE&lt;/code&gt; is &lt;code&gt;undefined&lt;/code&gt;.&lt;/p&gt;
&lt;h1 id=&quot;Second-attempt&quot;&gt;&lt;a href=&quot;#Second-attempt&quot; class=&quot;headerlink&quot; title=&quot;Second attempt&quot;&gt;&lt;/a&gt;Second attempt&lt;/h1&gt;&lt;p&gt;I was fixing this pattern issue, replacing it with &lt;code&gt;ARGUMENTS.length &amp;lt;= INDEX ? undefined : ARGUMENTS[INDEX]&lt;/code&gt;, when I noticed my previous patch was incomplete.&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;actual.js&lt;/span&gt;&lt;a href=&quot;https://github.com/babel/babel/blob/15969a09046a50ae2ae0503725b7fb00cdd7137f/packages/babel-plugin-transform-es2015-parameters/test/fixtures/parameters/rest-multiple/actual.js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;link&lt;/a&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; t = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; (&lt;span class=&quot;params&quot;&gt;f, ...items&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; x = f;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    x = items[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    x = items[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;was still being converted to:&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;expected.js&lt;/span&gt;&lt;a href=&quot;https://github.com/babel/babel/blob/15969a09046a50ae2ae0503725b7fb00cdd7137f/packages/babel-plugin-transform-es2015-parameters/test/fixtures/parameters/rest-multiple/expected.js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;link&lt;/a&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; t = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; (&lt;span class=&quot;params&quot;&gt;f&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; x = f;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    x = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    x = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;The transform was not taking into account the presence of a rest parameter when there were other parameters involved (&lt;code&gt;function (f, ...items)&lt;/code&gt;). After I fixed this issue, I had another one: &lt;code&gt;x = items[1]&lt;/code&gt; was correctly transformed, but not &lt;code&gt;x[1] = ...&lt;/code&gt;, &lt;code&gt;x.p = ...&lt;/code&gt; or &lt;code&gt;... = items[1] || something&lt;/code&gt;. I had to generalise the patch to (safely) cover all possible occurrences of accessing a value from a rest argument.&lt;/p&gt;
&lt;p&gt;I added a fixture test, reworked my patch and opened a new PR: &lt;a href=&quot;https://github.com/babel/babel/pull/3165&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Fixing T6818&lt;/a&gt;.&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;actual.js&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;u&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;f, g, ...items&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; x = f;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; y = g;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    x[&lt;span class=&quot;number&quot;&gt;12&lt;/span&gt;] = items[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    y.prop = items[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; z = items[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;] | &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || &lt;span class=&quot;number&quot;&gt;12&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;expected.js&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;u&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;f, g&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; x = f;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; y = g;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    x[&lt;span class=&quot;number&quot;&gt;12&lt;/span&gt;] = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;.length &amp;lt;= &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; ? &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt; : &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    y.prop = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;.length &amp;lt;= &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; ? &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt; : &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; z = (&lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;.length &amp;lt;= &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt; ? &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt; : &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;[&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;]) | &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || &lt;span class=&quot;number&quot;&gt;12&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Hopefully, this part is done. I’ll try to find some other Crankshaft-related-JS-anti-patterns in what Babel generates.&lt;/p&gt;</content>
    
    <summary type="html">
    
      What I did to help avoid bailouts on rest parameters transpilation.
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
      <category term="JavaScript" scheme="https://vhf.github.io/blog/categories/programming/JavaScript/"/>
    
    
      <category term="v8" scheme="https://vhf.github.io/blog/tags/v8/"/>
    
      <category term="crankshaft" scheme="https://vhf.github.io/blog/tags/crankshaft/"/>
    
      <category term="javascript" scheme="https://vhf.github.io/blog/tags/javascript/"/>
    
      <category term="es2015" scheme="https://vhf.github.io/blog/tags/es2015/"/>
    
      <category term="nodejs" scheme="https://vhf.github.io/blog/tags/nodejs/"/>
    
      <category term="babel" scheme="https://vhf.github.io/blog/tags/babel/"/>
    
  </entry>
  
  <entry>
    <title>JavaScript performance with Babel and Node.js: a case against default parameters in tail call optimizations</title>
    <link href="https://vhf.github.io/blog/2015/11/02/javascript-performance-with-babel-and-node-js/"/>
    <id>https://vhf.github.io/blog/2015/11/02/javascript-performance-with-babel-and-node-js/</id>
    <published>2015-11-02T12:36:59.000Z</published>
    <updated>2016-02-03T22:50:28.000Z</updated>
    
    <content type="html">&lt;p&gt;Disclaimer:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Babel 5.8.29 (babel-core 5.8.33)&lt;/li&gt;
&lt;li&gt;Node.js v5.0.0&lt;/li&gt;
&lt;li&gt;I know these factorial examples are very artificial, please bear with me, I’ll explain how I came to look at those things at the end of this post&lt;/li&gt;
&lt;li&gt;The title of this post might be incorrect (or too specific), I’ll also talk about it later&lt;/li&gt;
&lt;li&gt;Optimization is not an obsession of mine. Having fun with JavaScript is.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here are three recursive implementations of the factorial function:&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;tail-call.js&lt;/span&gt;&lt;a href=&quot;https://gist.github.com/vhf/25eebd0aa0ca5b3c1aec#file-tail-call-js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;gist&lt;/a&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// &quot;naive&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;factorial1&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;x&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (x &amp;lt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; x * factorial1(x&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// tail rec using a default parameter&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;factorial2&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;n&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; facRec2(n);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;facRec2&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;x, acc = 1&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (x &amp;lt;= &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; acc;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; facRec2(x&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, x*acc);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// tail rec&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;factorial3&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;n&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; facRec3(n, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;facRec3&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;x, acc&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (x &amp;lt;= &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; acc;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; facRec3(x&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, x*acc);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Which one do you think will perform better when transpiled into ES5, transformed by Babel’s tail call optimization (TCO for short), and run on Node.js (therefore V8)?&lt;/p&gt;
&lt;p&gt;It would be reasonable to expect:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;#1 to be the slowest because there’s no tail call (therefore TCO does not happen)&lt;/li&gt;
&lt;li&gt;#2 and #3 to perform better than #1 (because TCO)&lt;/li&gt;
&lt;li&gt;#2 and #3 to be more or less equivalent in terms of performances&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let’s &lt;a href=&quot;https://github.com/bestiejs/benchmark.js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;benchmark&lt;/a&gt; it (&lt;a href=&quot;https://gist.github.com/vhf/ecd9dba814a4edd80680&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;suite&lt;/a&gt;): &lt;code&gt;babel tail-call.js &amp;gt; tail-call-babel.js; node tail-call-babel.js&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#1 no tail call          x 1,562,075 ops/sec ±0.59% (98 runs sampled)
#2 TCO/default params    x   259,399 ops/sec ±0.92% (91 runs sampled)
#3 TCO/no default params x 7,046,389 ops/sec ±0.45% (101 runs sampled)
Fastest is #3 TCO/no default params
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;
&lt;li&gt;#3 is 27x (!) better than #2&lt;/li&gt;
&lt;li&gt;Even #1 significantly outperforms #2&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So my quest began. What could be so wrong about #2?&lt;/p&gt;
&lt;p&gt;The obvious thing to do at this point was to look at Babel’s output:&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;tail-call-babel.js&lt;/span&gt;&lt;a href=&quot;https://gist.github.com/vhf/d9e9750ae25e9dee6190#file-tail-call-babel-js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;gist&lt;/a&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&#39;use strict&#39;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// #1 &quot;naive&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;factorial1&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;x&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (x &amp;lt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; x * factorial1(x - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// #2 tail rec using a default parameter&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;factorial2&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;n&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; facRec2(n);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;facRec2&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;_x2&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; _arguments = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; _again = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  _function: &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (_again) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; x = _x2;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _again = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; acc = _arguments.length &amp;lt;= &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; || _arguments[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] === &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt; ? &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; : _arguments[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (x &amp;lt;= &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; acc;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      _arguments = [_x2 = x - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, x * acc];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      _again = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      acc = &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt; _function;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// #3 tail rec&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;factorial3&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;n&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; facRec3(n, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;facRec3&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;_x3, _x4&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; _again2 = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  _function2: &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (_again2) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; x = _x3,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        acc = _x4;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _again2 = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (x &amp;lt;= &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; acc;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      _x3 = x - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      _x4 = x * acc;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      _again2 = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt; _function2;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;My first reflex was to check if TCO happened. Yes, and it did a fine job at transforming both tail recursive functions &lt;code&gt;facRec2&lt;/code&gt; and &lt;code&gt;facRec3&lt;/code&gt; into iterative functions. (If &lt;code&gt;factorial2&lt;/code&gt; uses an iterative &lt;code&gt;facRec2&lt;/code&gt;, why would &lt;code&gt;factorial1&lt;/code&gt; and its still-recursive implementation perform better? It’s nice to know that &lt;code&gt;factorial2&lt;/code&gt; won’t bark &lt;code&gt;RangeError: Maximum call stack size exceeded&lt;/code&gt; at me, but at what cost?)&lt;/p&gt;
&lt;p&gt;The next obvious thing to do was to consider the only single little difference between &lt;code&gt;facRec2&lt;/code&gt; and &lt;code&gt;facRec3&lt;/code&gt; in the original code: the use of an ES6 default parameter. A quick glance at Babel’s output made the use of &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/arguments&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;arguments&lt;/code&gt;&lt;/a&gt;stand out.&lt;/p&gt;
&lt;p&gt;I remembered reading about &lt;a href=&quot;https://github.com/petkaantonov/bluebird/wiki/Optimization-killers&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;V8 “optimization killers”&lt;/a&gt;, particularly a bit about &lt;code&gt;arguments&lt;/code&gt;. Let me summarize the third section in the form of a checklist with regards to how the transformed &lt;code&gt;facRec2&lt;/code&gt; makes use of parameters and &lt;code&gt;arguments&lt;/code&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;[ ] Don’t reassign defined parameters while also mentioning &lt;code&gt;arguments&lt;/code&gt; in the body of a function&lt;/li&gt;
&lt;li&gt;[x] Don’t leak &lt;code&gt;arguments&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;[x] Don’t assign to &lt;code&gt;arguments&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;[x] Don’t use &lt;code&gt;arguments&lt;/code&gt; directly without &lt;code&gt;.length&lt;/code&gt; or &lt;code&gt;[]&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;[x] Don’t &lt;code&gt;arguments[i]&lt;/code&gt; with &lt;code&gt;i&lt;/code&gt; not an integer or &lt;code&gt;i &amp;gt; arguments.length-1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;[x] Don’t do anything else than &lt;code&gt;fn.apply(y, arguments)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Notice how &lt;code&gt;facRec2&lt;/code&gt; does &lt;code&gt;_x2 = x - 1&lt;/code&gt; although &lt;code&gt;_x2&lt;/code&gt; is a defined parameter &lt;em&gt;and&lt;/em&gt; &lt;code&gt;arguments&lt;/code&gt; is mentioned in the function body? It contradicts the first rule.&lt;/p&gt;
&lt;p&gt;I turned to V8. Here again, the awesome bluebird wiki page was very helpful: its first section, &lt;a href=&quot;https://github.com/petkaantonov/bluebird/wiki/Optimization-killers#1-tooling&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;tooling&lt;/a&gt;, had been my reference for some time.&lt;/p&gt;
&lt;p&gt;I added:&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;tail-call-babel-v8.js&lt;/span&gt;&lt;a href=&quot;https://gist.github.com/vhf/01c095e09accf72108a1#file-tail-call-babel-v8-js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;gist&lt;/a&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;printStatus&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;fn&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; name = fn.name;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt;(%GetOptimizationStatus(fn)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;: &lt;span class=&quot;built_in&quot;&gt;console&lt;/span&gt;.log(name, &lt;span class=&quot;string&quot;&gt;&#39; is optimized&#39;&lt;/span&gt;); &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;: &lt;span class=&quot;built_in&quot;&gt;console&lt;/span&gt;.log(name, &lt;span class=&quot;string&quot;&gt;&#39; is not optimized&#39;&lt;/span&gt;); &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;: &lt;span class=&quot;built_in&quot;&gt;console&lt;/span&gt;.log(name, &lt;span class=&quot;string&quot;&gt;&#39; is always optimized&#39;&lt;/span&gt;); &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;: &lt;span class=&quot;built_in&quot;&gt;console&lt;/span&gt;.log(name, &lt;span class=&quot;string&quot;&gt;&#39; is never optimized&#39;&lt;/span&gt;); &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;: &lt;span class=&quot;built_in&quot;&gt;console&lt;/span&gt;.log(name, &lt;span class=&quot;string&quot;&gt;&#39; is maybe deoptimized&#39;&lt;/span&gt;); &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;factorial1(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;factorial1(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;%OptimizeFunctionOnNextCall(factorial1);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;factorial1(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;printStatus(factorial1);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;facRec2(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;); &lt;span class=&quot;comment&quot;&gt;// I should add that facRec2(100) leads to the same perf issue&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;facRec2(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;%OptimizeFunctionOnNextCall(facRec2);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;facRec2(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;printStatus(facRec2);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;facRec3(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;facRec3(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;%OptimizeFunctionOnNextCall(facRec3);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;facRec3(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;printStatus(facRec3);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;at the end of &lt;code&gt;tail-call-babel.js&lt;/code&gt; and ran the following:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;node --allow-natives-syntax tail-call-babel.js
  factorial1 is optimized
  facRec2 is not optimized
  facRec3 is optimized
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It was clear that V8 — more precisely &lt;a href=&quot;http://jayconrod.com/posts/54/a-tour-of-v8-crankshaft-the-optimizing-compiler&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Crankshaft&lt;/a&gt; — was bailing out on &lt;code&gt;facRec2&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I simply had to refactor &lt;code&gt;facRec2&lt;/code&gt; to make it stop reassigning to &lt;code&gt;_x2&lt;/code&gt;, right? Nope, &lt;code&gt;facRec2&lt;/code&gt; still could not be optimized. Here’s a &lt;a href=&quot;https://gist.github.com/vhf/5560a6502d5147a766f6&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;gist&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Going back to the checklist, I noticed that &lt;code&gt;facRec2&lt;/code&gt; actually assigns to the &lt;code&gt;_arguments&lt;/code&gt; object, which is a reference to &lt;code&gt;arguments&lt;/code&gt;, which also contradicts something from the above checklist: Don’t assign to &lt;code&gt;arguments&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Going back to the &lt;code&gt;facRec2&lt;/code&gt; generated code, I copied it to create &lt;code&gt;facRec2b&lt;/code&gt;, replacing &lt;code&gt;var _arguments = arguments;&lt;/code&gt; with &lt;code&gt;var $_len = arguments.length; var _arguments = new Array($_len); for(var $_i = 0; $_i &amp;lt; $_len; ++$_i) {_arguments[$_i] = arguments[$_i];}&lt;/code&gt; (&lt;a href=&quot;https://gist.github.com/vhf/58769c1d0462094a66a3&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;full gist&lt;/a&gt;). And V8 was happy: &lt;code&gt;facRec2b is optimized&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;New benchmark:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#1 no tail call               x 1,562,300 ops/sec ±0.44% (98 runs sampled)
#2 TCO/default params + leak  x   256,521 ops/sec ±0.96% (95 runs sampled)
#2 TCO/default params no leak x   812,920 ops/sec ±0.83% (94 runs sampled)
#3 TCO/no default params      x 7,060,279 ops/sec ±0.49% (94 runs sampled)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;When optimized by V8, &lt;code&gt;facRec2b&lt;/code&gt; runs already 3x faster than its &lt;code&gt;facRec2&lt;/code&gt; counterpart, but still ~2x slower than &lt;code&gt;factorial1&lt;/code&gt;, and their performances cannot be matched with &lt;code&gt;facRec3&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Here were my initial conclusions:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;assigning to &lt;code&gt;_arguments&lt;/code&gt;, which references &lt;code&gt;arguments&lt;/code&gt;, is what prevents V8 from optimizing &lt;code&gt;facRec2&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;safely converting &lt;code&gt;arguments&lt;/code&gt; to an array fixes this issue&lt;/li&gt;
&lt;li&gt;even with this fix, &lt;code&gt;facRec2b&lt;/code&gt; is still so slow that we should simply decide not to use default parameters in any function susceptible to be TCOed by Babel&lt;/li&gt;
&lt;li&gt;is there a better way to get V8 to optimize &lt;code&gt;facRec2&lt;/code&gt;?&lt;/li&gt;
&lt;li&gt;what’s up with this &lt;em&gt;Don’t reassign defined parameters while also mentioning &lt;code&gt;arguments&lt;/code&gt; in the body of a function&lt;/em&gt; rule? I thought &lt;a href=&quot;https://gist.github.com/vhf/a884c556a70bdcf21fbc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;this&lt;/a&gt; would trigger an &lt;em&gt;Assignment to parameter in arguments object&lt;/em&gt; but I could not make it happen. Answer at the end of this post.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Was there more to it?&lt;/p&gt;
&lt;p&gt;I took a closer look:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;node --trace-opt --trace_deopt --allow-natives-syntax tail-call-babel.js | grep facRec2 | grep -v facRec2b
  [compiling method 0x11469d0922c1 &amp;lt;JS Function facRec2 (SharedFunctionInfo 0x24a5614171a9)&amp;gt; using Crankshaft]
  [aborted optimizing 0x11469d0922c1 &amp;lt;JS Function facRec2 (SharedFunctionInfo 0x24a5614171a9)&amp;gt; because: Unsupported phi use of arguments]
  [disabled optimization for 0x24a5614171a9 &amp;lt;SharedFunctionInfo facRec2&amp;gt;, reason: Unsupported phi use of arguments]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Unsupported phi use of arguments. At this point I should probably say that I don’t know much about V8 internals or source code. However, I was still determined to know what was wrong with &lt;code&gt;facRec2&lt;/code&gt;, so I tried looking for this cryptic &lt;code&gt;Unsupported phi use of arguments&lt;/code&gt; thing on Google (after all, they are the most qualified for this particular request).&lt;/p&gt;
&lt;p&gt;It’s not every day that one of my search engine requests only returns 11 results. The most interesting one is probably &lt;a href=&quot;https://codereview.chromium.org/7553006&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;the very commit that introduced this bailout reason&lt;/a&gt;. I took a quick glance at &lt;code&gt;HGraph::CheckPhis&lt;/code&gt;: something about blocks?&lt;/p&gt;
&lt;p&gt;I thought I would learn more trying to write a minimal program reproducing this bailout reason. But that was not an easy task. What I ended up with are these three functions:&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;figcaption&gt;&lt;span&gt;unsupported-phi-use-of-arguments.js&lt;/span&gt;&lt;a href=&quot;https://gist.github.com/vhf/5f88c10e2a0680a4fb19#file-unsupported-phi-use-of-arguments-js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;gist&lt;/a&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;phi1&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; _arguments = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; === &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123; &lt;span class=&quot;comment&quot;&gt;// anything evaluating to true, except a number or `true`&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _arguments = [&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]; &lt;span class=&quot;comment&quot;&gt;// Unsupported phi use of arguments&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;phi2&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; _arguments = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _arguments = [&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]; &lt;span class=&quot;comment&quot;&gt;// Unsupported phi use of arguments&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;phi3&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; _arguments = &lt;span class=&quot;built_in&quot;&gt;arguments&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; again = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (again) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _arguments = [&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]; &lt;span class=&quot;comment&quot;&gt;// Unsupported phi use of arguments&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    again = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;HGraph::CheckPhis&lt;/code&gt; started to make sense: reassigning &lt;code&gt;arguments&lt;/code&gt; inside a “block” triggers &lt;em&gt;Unsupported phi use of arguments&lt;/em&gt;. But assigning &lt;em&gt;to&lt;/em&gt; &lt;code&gt;arguments&lt;/code&gt; does not: it triggers a &lt;em&gt;Bad value context for arguments value&lt;/em&gt;, which is already covered on &lt;a href=&quot;http://bahmutov.calepin.co/detecting-function-optimizations-in-v8.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;blogs&lt;/a&gt; and &lt;a href=&quot;http://stackoverflow.com/questions/29198195/whats-the-deal-with-optimising-arguments&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;StackOverflow&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;So-what’s-your-point-Conclusion&quot;&gt;&lt;a href=&quot;#So-what’s-your-point-Conclusion&quot; class=&quot;headerlink&quot; title=&quot;So, what’s your point? Conclusion.&quot;&gt;&lt;/a&gt;So, what’s your point? Conclusion.&lt;/h3&gt;&lt;p&gt;I just wanted to practice my storytelling. And also, I wanted to raise this question: what can we do about this whole default-parameter-TCO-V8-thing? I’m not sure, so here are a few questions I would like to ask you:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Should we just avoid using default parameters in any function susceptible to be TCOed by Babel? (in this example, x27 on V8)&lt;/li&gt;
&lt;li&gt;or make Babel safely create an array from &lt;code&gt;arguments&lt;/code&gt; in such cases? (x3)&lt;/li&gt;
&lt;li&gt;or at least mention this thing in Babel’s doc as soon as Babel 6 unblacklists &lt;code&gt;es6.tailCall&lt;/code&gt;? (If this ever happens? If you have informations about this blacklisting, I’d love to know!)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;I’d love to get your opinion on these questions!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In a very interesting &lt;a href=&quot;https://devchat.tv/js-jabber/171-jsj-babel-with-sebastian-mckenzie&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;recent podcast&lt;/a&gt; ([&lt;a href=&quot;http://devchat.cachefly.net/javascriptjabber/transcript-171-jsj-babel-with-sebastian-mckenzie-js-jabber.pdf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;transcript&lt;/a&gt;]), Babel’s author Sebastian McKenzie said several things about Babel’s performances, and how outputting more performant code impacts its readability, and how that’s ok because the focus is on performance: “would you care more about your code being pretty or your code being as fast as possible?”, and I agree, it is certainly more important for Babel to be fast than readable.&lt;/p&gt;
&lt;p&gt;But he also said the following: “But now it’s just like you really shouldn’t be reading your compiled code anyway.” I have to disagree. In fact, if you indeed care about performances, you most probably &lt;em&gt;should&lt;/em&gt; be reading your compiled code. (Now, don’t get met wrong: I think Babel is an awesome piece of software and I love it and I use it everywhere and Sebastian McKenzie et al. are doing a terrific job, and if you think this post is bashing Babel you’re just plain wrong. This disclaimer is probably useless, but I’m new to blogging and it’s kind of scary.)&lt;/p&gt;
&lt;p&gt;I would love Babel to improve on this specific point; I can’t promise anything but I’ll try to hack on it. And if it gets me somewhere, I’ll try to write it up. My storytelling needs practice.&lt;/p&gt;
&lt;h4 id=&quot;Unsupported-phi-use-of-arguments&quot;&gt;&lt;a href=&quot;#Unsupported-phi-use-of-arguments&quot; class=&quot;headerlink&quot; title=&quot;Unsupported phi use of arguments&quot;&gt;&lt;/a&gt;Unsupported phi use of arguments&lt;/h4&gt;&lt;p&gt;Unsatisfied of my poor understanding of this Crankshaft bailout message I reached out to &lt;a href=&quot;http://mrale.ph&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Vyacheslav Egorov&lt;/a&gt;, who first introduced it and promptly clarified he did not add the bailout itself.&lt;/p&gt;
&lt;p&gt;I asked him what does &lt;code&gt;blocks_&lt;/code&gt; contain in the &lt;code&gt;HGraph::CheckPhis&lt;/code&gt; function I mentioned earlier:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Blocks will contain CFG (control flow graph) blocks — these are not blocks in the syntactical sense, e.g. &lt;code&gt;x ? y : z&lt;/code&gt; is not a block in JavaScript but will be 4 blocks in the CFG — once optimizing compiler gets to it.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;What’s up with this &lt;em&gt;Don’t reassign defined parameters while also mentioning &lt;code&gt;arguments&lt;/code&gt; in the body of a function&lt;/em&gt; rule? Why does &lt;a href=&quot;https://gist.github.com/vhf/a884c556a70bdcf21fbc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;this code&lt;/a&gt; not trigger a bailout?&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This limitation is still there — but it does not apply to strict functions. I think you somehow run your code in strict mode that’s why you don’t see a bailout.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Indeed, I ran my tests in strict mode.&lt;/p&gt;
&lt;p&gt;Regarding the second point of my conclusion, he said:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Allocating array (and hope it will get handled by some optimization pass in the V8) is a bad idea.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Thanks to Vyacheslav, this bailout message starts to make sense to me. He could have only answered the few questions I sent him by email. Instead, he was kind enough to answer them, read a draft of this blog post, and even went on to write a thorough and clear explaination of &lt;em&gt;Unsupported phi use of arguments&lt;/em&gt; on his blog: &lt;a href=&quot;http://mrale.ph/blog/2015/11/02/crankshaft-vs-arguments-object.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Crankshaft vs arguments object&lt;/a&gt; — which I still need to digest.&lt;/p&gt;
&lt;h4 id=&quot;A-few-side-notes&quot;&gt;&lt;a href=&quot;#A-few-side-notes&quot; class=&quot;headerlink&quot; title=&quot;A few side notes&quot;&gt;&lt;/a&gt;A few side notes&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/babel/babel/tree/v5.8.33/packages/babel/test/fixtures/transformation/es6.tail-call/recursion&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;es6.tailCall recursion test case including default parameter&lt;/a&gt;: Interesting test case with regards to V8 optimization: first because &lt;code&gt;_x2&lt;/code&gt; (a defined parameter) gets reassigned which triggers &lt;em&gt;Assignment to parameter in arguments object&lt;/em&gt; bailout reason, secondly because if we &lt;code&gt;var __x2 = _x2&lt;/code&gt; and don’t reassign &lt;code&gt;_x2&lt;/code&gt; we get the infamous &lt;em&gt;Unsupported phi use of arguments&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;Why the title of this post might be too specific: I have not investigated (yet?) whether &lt;em&gt;Unsupported phi use of arguments&lt;/em&gt; is only triggered by Babel generated ES5 in the specific &lt;em&gt;TCO + default parameter&lt;/em&gt; case or is also present in other Babel generated ES5 &lt;em&gt;default parameter&lt;/em&gt; cases.&lt;/li&gt;
&lt;li&gt;Why these artifical examples: because they are short and easy to reason about. Also, cf. the following point:&lt;/li&gt;
&lt;li&gt;How did you come up with this thing? One of might projects depends on underscore, which does not have an equivalent of &lt;a href=&quot;https://lodash.com/docs#get&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;get&lt;/code&gt;&lt;/a&gt;. So I quickly drafted the tail rec &lt;code&gt;_.get&lt;/code&gt; I was dreaming of, then googled for a bit and found John-David Dalton’s &lt;a href=&quot;https://github.com/jashkenas/underscore/issues/2268#issuecomment-128731431&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;_.reduce(path, _.partial(_.result, _, _, void 0), object)&lt;/code&gt;&lt;/a&gt;(which felt like too much black magic for me). But me being curious and it being a cold evening, I benchmarked both solutions. And mine was awfully slow. So I asked V8 about it, discovered the &lt;em&gt;phi&lt;/em&gt; thing, reimplemented my recursive &lt;code&gt;get&lt;/code&gt; without its default parameter, ran the benchmark again and got this: &lt;code&gt;TCO 676,411(±0.43%) | 674,426(±0.49%) JDD&lt;/code&gt;. So, basically the same performances. Underscore never fails to impress me! Which led to two things: 1/ I kept my nice recursive &lt;code&gt;get&lt;/code&gt; because it’s more readable, 2/ I spent my weekend researching+writing this blog post.&lt;/li&gt;
&lt;li&gt;I know I should probably not rely on this benchmark package and should do cpu profiling instead, and that it’s easy to do with V8, etc. I think the timing differences shown here are big enough to decide that for this particular post, benchmark is good enough. But I’ll do better next time.&lt;/li&gt;
&lt;/ul&gt;</content>
    
    <summary type="html">
    
      Babel might prevent some V8 optimizations to happen. Also, have you heard about Unsupported Phi Use of Arguments?
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
      <category term="JavaScript" scheme="https://vhf.github.io/blog/categories/programming/JavaScript/"/>
    
    
      <category term="v8" scheme="https://vhf.github.io/blog/tags/v8/"/>
    
      <category term="crankshaft" scheme="https://vhf.github.io/blog/tags/crankshaft/"/>
    
      <category term="javascript" scheme="https://vhf.github.io/blog/tags/javascript/"/>
    
      <category term="es2015" scheme="https://vhf.github.io/blog/tags/es2015/"/>
    
      <category term="nodejs" scheme="https://vhf.github.io/blog/tags/nodejs/"/>
    
      <category term="babel" scheme="https://vhf.github.io/blog/tags/babel/"/>
    
  </entry>
  
  <entry>
    <title>ES6 Destructuring</title>
    <link href="https://vhf.github.io/blog/2015/10/28/es6-destructuring/"/>
    <id>https://vhf.github.io/blog/2015/10/28/es6-destructuring/</id>
    <published>2015-10-28T14:29:42.000Z</published>
    <updated>2016-02-03T22:50:28.000Z</updated>
    
    <content type="html">&lt;ul&gt;
&lt;li&gt;Destructuring works exactly as its syntax suggests&lt;/li&gt;
&lt;li&gt;The only tricky point is object destructuring without variable declaration&lt;ul&gt;
&lt;li&gt;with declaration: &lt;code&gt;let {x: a} = {x: &amp;#39;a&amp;#39;};&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;without declaration: &lt;code&gt;({x: a} = {x: &amp;#39;a&amp;#39;});&lt;/code&gt; (assuming that &lt;code&gt;a&lt;/code&gt; has already been declared)&lt;/li&gt;
&lt;li&gt;It’s simply because &lt;a href=&quot;http://stackoverflow.com/questions/17382024/why-is-a-bare-array-valid-javascript-syntax-but-not-a-bare-object&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;a bare object is not valid syntax&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Default arguments and destructuring:&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* prop === &#39;default&#39; */&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &amp;#123; prop = &lt;span class=&quot;string&quot;&gt;&#39;default&#39;&lt;/span&gt; &amp;#125; = &amp;#123;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* prop === &#39;value&#39; */&lt;/span&gt;   &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &amp;#123; prop = &lt;span class=&quot;string&quot;&gt;&#39;default&#39;&lt;/span&gt; &amp;#125; = &amp;#123; prop: &lt;span class=&quot;string&quot;&gt;&#39;value&#39;&lt;/span&gt; &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* name === &#39;value&#39; */&lt;/span&gt;   &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &amp;#123; prop: name = &lt;span class=&quot;string&quot;&gt;&#39;default&#39;&lt;/span&gt; &amp;#125; = &amp;#123; prop: &lt;span class=&quot;string&quot;&gt;&#39;value&#39;&lt;/span&gt; &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;Default arguments also work for arrays:&lt;ul&gt;
&lt;li&gt;&lt;code&gt;let [head = &amp;quot;default&amp;quot;] = [];&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Default values for destructuring assignment is especially useful as function arguments defaults:&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; destructObject = (&amp;#123; a = &lt;span class=&quot;string&quot;&gt;&#39;a&#39;&lt;/span&gt;, b = &lt;span class=&quot;string&quot;&gt;&#39;b&#39;&lt;/span&gt; &amp;#125; = &amp;#123;&amp;#125;) =&amp;gt; [a, b];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; destructObject = (&amp;#123; a: arg1 = &lt;span class=&quot;string&quot;&gt;&#39;a&#39;&lt;/span&gt;, b: arg2 = &lt;span class=&quot;string&quot;&gt;&#39;b&#39;&lt;/span&gt; &amp;#125; = &amp;#123;&amp;#125;) =&amp;gt; [arg1, arg2];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;destructObject(&amp;#123;&amp;#125;);       &lt;span class=&quot;comment&quot;&gt;// [&#39;a&#39;, &#39;b]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;destructObject(&amp;#123; b: &lt;span class=&quot;string&quot;&gt;&#39;c&#39;&lt;/span&gt; &amp;#125;); &lt;span class=&quot;comment&quot;&gt;// [&#39;a&#39;, &#39;c&#39;]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
    
    <summary type="html">
    
      A few things about destructuring and assigning default values.
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
      <category term="JavaScript" scheme="https://vhf.github.io/blog/categories/programming/JavaScript/"/>
    
    
      <category term="javascript" scheme="https://vhf.github.io/blog/tags/javascript/"/>
    
      <category term="es2015" scheme="https://vhf.github.io/blog/tags/es2015/"/>
    
  </entry>
  
  <entry>
    <title>JavaScript Promises</title>
    <link href="https://vhf.github.io/blog/2015/10/27/javascript-promises/"/>
    <id>https://vhf.github.io/blog/2015/10/27/javascript-promises/</id>
    <published>2015-10-27T18:37:41.000Z</published>
    <updated>2016-02-03T22:50:28.000Z</updated>
    
    <content type="html">&lt;p&gt;I read &lt;a href=&quot;https://60devs.com/best-practices-for-using-promises-in-js.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Best Practices for Using Promises in JS&lt;/a&gt;. Here are some concise notes expanding on this topic.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Let’s use bluebird as Promise implementation for node&lt;/li&gt;
&lt;li&gt;Use &lt;code&gt;.then().catch()&lt;/code&gt; instead of &lt;code&gt;.then(successCb, failCb)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; promise = (shouldResolve) =&amp;gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;Promise&lt;/span&gt;((resolve, reject) =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (shouldResolve) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    resolve();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    reject();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;promise(arg)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .then(() =&amp;gt; &amp;#123; &lt;span class=&quot;comment&quot;&gt;/* success */&lt;/span&gt; &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .catch(ExceptionToCatch, OtherExceptionToCatch, (err) =&amp;gt; &amp;#123; &lt;span class=&quot;comment&quot;&gt;/* error */&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .catch(StrangeExceptionToCatch, (err) =&amp;gt; &amp;#123; &lt;span class=&quot;comment&quot;&gt;/* error */&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .catch((err) =&amp;gt; &amp;#123; &lt;span class=&quot;comment&quot;&gt;/* error */&lt;/span&gt;&amp;#125;); &lt;span class=&quot;comment&quot;&gt;// default&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;To define an exception to catch:&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MyCustomError&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) &lt;/span&gt;&amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MyCustomError.prototype = &lt;span class=&quot;built_in&quot;&gt;Object&lt;/span&gt;.create(&lt;span class=&quot;built_in&quot;&gt;Error&lt;/span&gt;.prototype);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;promise(arg)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .then(() =&amp;gt; &amp;#123; &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; MyCustomError() &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .catch(MyCustomError, (err) =&amp;gt; &amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .catch((err) =&amp;gt; &amp;#123;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Promise.all([promiseA(a), promiseB(b)])&lt;/code&gt; runs two async functions in parallel, but &lt;code&gt;.then(() =&amp;gt; {})&lt;/code&gt; callback has no data result argument&lt;/li&gt;
&lt;li&gt;Use &lt;code&gt;.spread&lt;/code&gt; instead of &lt;code&gt;.then&lt;/code&gt; to get this data: &lt;code&gt;.spread((dataA, dataB) =&amp;gt; {})&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;To limit concurrency, &lt;code&gt;Promise.map([lotsOfStuff], promise, { concurrency: 3 }).then(() =&amp;gt; {})&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;See also &lt;code&gt;.reduce&lt;/code&gt; and &lt;code&gt;.filter&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;You can “pipe” your &lt;code&gt;.then&lt;/code&gt; functions. If you do this, you should probably avoid using anonymous functions and enjoy more reusability, modularity, testability, readability&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;readFile(data)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .then(&lt;span class=&quot;built_in&quot;&gt;JSON&lt;/span&gt;.parse)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .then(treatStuff)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .catch(handleError)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;Don’t abuse this thing. It’s nice to read, but it breaks the event loop and could introduce race conditions&lt;/li&gt;
&lt;li&gt;A better approach is to pipe inside the &lt;code&gt;.then&lt;/code&gt;:&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;readFile(data)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .then(pipe(&lt;span class=&quot;built_in&quot;&gt;JSON&lt;/span&gt;.parse, treatStuff))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  .catch(handleError)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;Further-reading&quot;&gt;&lt;a href=&quot;#Further-reading&quot; class=&quot;headerlink&quot; title=&quot;Further reading:&quot;&gt;&lt;/a&gt;Further reading:&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://bluebirdjs.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://bluebirdjs.com&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://promise-nuggets.github.io&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://promise-nuggets.github.io&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/getify/You-Dont-Know-JS/blob/master/async%20%26%20performance/ch3.md&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/getify/You-Dont-Know-JS/blob/master/async%20%26%20performance/ch3.md&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content>
    
    <summary type="html">
    
      Promises, and what bluebird can do to help.
    
    </summary>
    
      <category term="programming" scheme="https://vhf.github.io/blog/categories/programming/"/>
    
      <category term="JavaScript" scheme="https://vhf.github.io/blog/categories/programming/JavaScript/"/>
    
    
      <category term="javascript" scheme="https://vhf.github.io/blog/tags/javascript/"/>
    
      <category term="es2015" scheme="https://vhf.github.io/blog/tags/es2015/"/>
    
      <category term="promises" scheme="https://vhf.github.io/blog/tags/promises/"/>
    
      <category term="nodejs" scheme="https://vhf.github.io/blog/tags/nodejs/"/>
    
  </entry>
  
</feed>
